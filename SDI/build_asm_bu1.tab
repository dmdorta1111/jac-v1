BEGIN_GUI_DESCR


IF FRAMES_ == 1
	USER_INPUT_PARAM STRING FRAME_WO
	DOOR_WO = "99999"
END_IF
IF DOORS_ == 1
	USER_INPUT_PARAM STRING DOOR_WO
	FRAME_WO = "99999"
END_IF


CHECKBOX_PARAM INTEGER FRAMES_ "YES/NO"
CHECKBOX_PARAM INTEGER DOORS_ "YES/NO"

CHECKBOX_PARAM INTEGER BUILD_ASM
CHECKBOX_PARAM INTEGER REPLACE_COMP
CHECKBOX_PARAM INTEGER PART_LIST
CHECKBOX_PARAM INTEGER EXPORT_DXF
CHECKBOX_PARAM INTEGER REQUISITIONS
CHECKBOX_PARAM INTEGER DRAWINGS

END_GUI_DESCR

BEGIN_ASM_DESCR

!USED TO CONTROL PROCESS
DECLARE_VARIABLE	BOOL 		EOF FALSE
DECLARE_VARIABLE	DOUBLE	LENGTH
DECLARE_VARIABLE	DOUBLE	TEST_LENGTH
DECLARE_VARIABLE	DOUBLE	TEST_THICKNESS
DECLARE_VARIABLE	DOUBLE	TEST_WIDTH
DECLARE_VARIABLE	DOUBLE	THICKNESS
DECLARE_VARIABLE	DOUBLE	WIDTH
DECLARE_VARIABLE	DOUBLE	X
DECLARE_VARIABLE	DOUBLE	Y
DECLARE_VARIABLE	DOUBLE	Z
DECLARE_VARIABLE	INTEGER	BUILD_INDEX
DECLARE_VARIABLE	INTEGER	EXCEL_COLUMN 0
DECLARE_VARIABLE	INTEGER	EXCEL_ROW 0
DECLARE_VARIABLE	INTEGER	FINISH
DECLARE_VARIABLE	INTEGER	GRADE
DECLARE_VARIABLE	INTEGER	QUANTITY
DECLARE_VARIABLE	INTEGER	SHEET_QTY 0
DECLARE_VARIABLE	INTEGER	STOCKTYPE
DECLARE_VARIABLE	INTEGER	TEST_FINISH
DECLARE_VARIABLE	INTEGER	TEST_GRADE
DECLARE_VARIABLE	INTEGER	TEST_ROW
DECLARE_VARIABLE	STRING	COMPONENT_NAME
DECLARE_VARIABLE	STRING	CUSTOMER_NAME
DECLARE_VARIABLE	STRING	DONE
DECLARE_VARIABLE	STRING	DOOR_WO
DECLARE_VARIABLE	STRING	DXF_DIRECTORY
DECLARE_VARIABLE	STRING	EXCEL_COMPONENT_NAME ""
DECLARE_VARIABLE	STRING	EXCEL_DOCUMENT_NAME
DECLARE_VARIABLE	STRING	EXISTING_DIRECTORY
DECLARE_VARIABLE	STRING	EXISTING_EXCEL
DECLARE_VARIABLE	STRING	FRAME_WO
DECLARE_VARIABLE	STRING	INSTANCE_NAME
DECLARE_VARIABLE	STRING	ITEM_NUM ""
DECLARE_VARIABLE	STRING	JOB_NAME
DECLARE_VARIABLE	STRING	MATCH
DECLARE_VARIABLE	STRING	MDL
DECLARE_VARIABLE	STRING	PROCESS_STATE
DECLARE_VARIABLE	STRING	PROJECT_DIRECTORY
DECLARE_VARIABLE	STRING	READY
DECLARE_VARIABLE	STRING	SO_NUM
DECLARE_VARIABLE	STRING	STATE
DECLARE_VARIABLE	STRING	SUB_JOB_NAME
DECLARE_VARIABLE	STRING	TEST_COMPONENT
DECLARE_VARIABLE	STRING	TEST_EOF "FALSE"
DECLARE_VARIABLE	STRING	TEST_TYPE
DECLARE_VARIABLE	STRING	TYPE
DECLARE_VARIABLE	STRING	BOM_DOCUMENT_NAME
DECLARE_VARIABLE	STRING	SHAPE
DECLARE_VARIABLE	STRING	WO_NUM ""
DECLARE_VARIABLE	STRING	SWIDTH
DECLARE_VARIABLE	STRING	SLENGTH
DECLARE_VARIABLE	STRING 	TEM_DESC
DECLARE_VARIABLE	STRING	SINDEX
DECLARE_VARIABLE	INTEGER	LIST_INDEX
DECLARE_VARIABLE	STRING	MODEL_NAME
DECLARE_VARIABLE	INTEGER	ROW 1
DECLARE_VARIABLE	INTEGER	QUANTITY 1
DECLARE_VARIABLE 	STRING	MATCH
DECLARE_VARIABLE	STRING	INSTANCE_NAME
DECLARE_VARIABLE	STRING	COMPONENT_NAME
DECLARE_VARIABLE 	INTEGER BUILD_ASM
DECLARE_VARIABLE 	INTEGER REPLACE_COMP
DECLARE_VARIABLE 	INTEGER EXPORT_DXF
DECLARE_VARIABLE 	INTEGER PART_LIST
DECLARE_VARIABLE 	INTEGER REQUISITIONS
DECLARE_VARIABLE	STRING	MDLTYPE
DECLARE_VARIABLE	STRING	MDLTYPE1
DECLARE_VARIABLE	STRING	MDLTYPE2
DECLARE_VARIABLE	STRING	EMJACDESC
DECLARE_VARIABLE	STRING	ITEM_DESC
DECLARE_VARIABLE 	STRING 	PTCNAME
DECLARE_ARRAY ALL_COMPONENTS
DECLARE_ARRAY COMPONENT_GENERIC_INSTANCE_NAMES
DECLARE_ARRAY GENERIC_ITEMS
DECLARE_ARRAY DELETE_ITEMS
DECLARE_ARRAY DELETE_ITEM

! BUILD_ASM = 1
! REPLACE_COMP = 1
! PART_LIST = 1
! EXPORT_DXF = 1
! REQUISITIONS = 1

DECLARE_ARRAY EXCEL_FILES
DECLARE_ARRAY CSYS_ARRAY
DECLARE_ARRAY SURFACE_ARRAY


USER_INPUT_PARAM STRING SO_NUM
SET_WORKING_DIRECTORY "C:\000_SDI"
PROJECT_DIRECTORY = "C:\000_SDI\\" + SO_NUM
READ_SUBDIRECTORIES . PROJECTS
EXISTING_DIRECTORY = -1

FOR PROJECT REF ARRAY PROJECTS
	EXISTING_DIRECTORY = strfind (PROJECT, SO_NUM)
	IF EXISTING_DIRECTORY <> -1
		SET_WORKING_DIRECTORY PROJECT_DIRECTORY
		BREAK
	END_IF
END_FOR

IF EXISTING_DIRECTORY == -1
	MESSAGE_BOX "SALES ORDER DOES NOT EXIST"
	EXIT
END_IF

CLEAR_ARRAY EXCEL_FILES
EXCEL_DOCUMENT_NAME = SO_NUM
EXISTING_EXCEL = -1
READ_DIRECTORY PROJECT_DIRECTORY "*.xls" EXCEL_FILES
GET_ARRAY_SIZE EXCEL_FILES sizeTestArray

IF sizeTestArray > 0
	FOR EXCEL_DOCUMENT REF ARRAY EXCEL_FILES
		EXISTING_EXCEL = strfind (EXCEL_DOCUMENT, EXCEL_DOCUMENT_NAME)
		IF EXISTING_EXCEL <> -1
			EXCEL_CONNECT
			EXCEL_LOAD_DOCUMENT EXCEL_DOCUMENT_NAME
			EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "OPENING"
			EXCEL_GET_VALUE CELL_BY_NAME "B1" CUSTOMER_NAME
			EXCEL_GET_VALUE CELL_BY_NAME "B2" JOB_NAME
			EXCEL_GET_VALUE CELL_BY_NAME "B3" SO_NUM
			BREAK
		END_IF
	END_FOR
END_IF

IF EXISTING_EXCEL == -1
	MESSAGE_BOX "EXCEL FILE DOES NOT EXIST"
	EXIT
END_IF


CONFIG_ELEM
IF FRAME_WO <> "99999"
	WO_NUM = FRAME_WO
END_IF
IF DOOR_WO <> "99999"
	WO_NUM = DOOR_WO
END_IF
!SET DIRECTORY AND CREATE SPREAD SHEET
EXCEL_COLUMN = 1
EOF = FALSE


IF BUILD_ASM == 1
	EXCEL_ACTIVATE_DOCUMENT EXCEL_DOCUMENT_NAME
	EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "OPENING"

	RETRIEVE_MDL WO_ASSEM.ASM ASSEM
	SEARCH_MDL_REF ASSEM CSYS "*" ATTACH

	SET_MDL_PARAM ASSEM "CUSTOMER" CUSTOMER_NAME
	SET_MDL_PARAM ASSEM "JOB_NAME" JOB_NAME
	SET_MDL_PARAM ASSEM "SO_NUM" SO_NUM
	SET_MDL_PARAM ASSEM "WO_NUM" WO_NUM
	SET_MDL_PARAM ASSEM "ITEM_NUM" " "
	SET_MDL_PARAM ASSEM "ITEM_DESC" "SEE TABLE"

	IF FRAMES_ == 1 AND FRAME_WO <> "99999"
		SET_MDL_NAME ASSEM "FRAMES_"+SO_NUM+"_"+FRAME_WO
	END_IF

	IF DOORS_ == 1 AND DOOR_WO <> "99999"
		SET_MDL_NAME ASSEM "DOORS_"+SO_NUM+"_"+DOOR_WO
	END_IF

	!BUILD MFG ASSY
	EXCEL_ACTIVATE_DOCUMENT EXCEL_DOCUMENT_NAME
	EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "OPENING"

	EXCEL_GET_VALUE 0 1 TEST_EOF
	IF TEST_EOF <> ""
		EOF = "FALSE"
	ELSE
		EOF = "TRUE"
	END_IF

	WHILE EOF == "FALSE"
		EXCEL_GET_VALUE 0 EXCEL_COLUMN ITEM_NUM
		EXCEL_GET_VALUE 3 EXCEL_COLUMN READY
		EXCEL_GET_VALUE 4 EXCEL_COLUMN DONE
		EXCEL_GET_VALUE 5 EXCEL_COLUMN ITEM_NUM
		EXCEL_GET_VALUE 54 EXCEL_COLUMN SUB_TYPE
		EXCEL_GET_VALUE 293 EXCEL_COLUMN MASTER_TAG
		IF ITEM_NUM == MASTER_TAG AND READY == "YES" AND DONE == "YES"
			IF FRAME_WO <> "99999"
				EXCEL_SET_VALUE 290	EXCEL_COLUMN FRAME_WO
				RETRIEVE_MDL "frame_asm_"+ITEM_NUM+".ASM" ASM_MDL
				SEARCH_MDL_REF ASM_MDL CSYS "*" PLACEMENT
				EXCEL_GET_VALUE 271	EXCEL_COLUMN	SHEET_QTY
				BUILD_INDEX = 1
				WHILE BUILD_INDEX <= SHEET_QTY
					CREATE_UDF udf\csys ASSEM
						UDF_REF ATTACH ATTACH
						UDF_DIM	ROTX 0
						UDF_DIM	ROTY 0
						UDF_DIM	ROTZ 0
						UDF_DIM	LOCX 0
						UDF_DIM	LOCY 0
						UDF_DIM	LOCZ 12
						UDF_EXP_REF  ATTACH CSYS 0
					END_CREATE_UDF
					ASSEMBLE ASM_MDL ASSEM
						CSYS ATTACH PLACEMENT
					END_ASSEMBLE
					BUILD_INDEX++
				END_WHILE
			ELSE_IF DOOR_WO <> "99999"
				EXCEL_SET_VALUE 291	EXCEL_COLUMN DOOR_WO
				RETRIEVE_MDL "door_asm_1_"+SO_NUM+"_"+ITEM_NUM+".ASM" ASM_MDL
				SEARCH_MDL_REF ASM_MDL CSYS "*" PLACEMENT
				EXCEL_GET_VALUE 296	EXCEL_COLUMN	SHEET_QTY
				BUILD_INDEX = 1
				WHILE BUILD_INDEX <= SHEET_QTY
					CREATE_UDF udf\csys ASSEM
						UDF_REF ATTACH ATTACH
						UDF_DIM	ROTX 0
						UDF_DIM	ROTY 0
						UDF_DIM	ROTZ 0
						UDF_DIM	LOCX 0
						UDF_DIM	LOCY 0
						UDF_DIM	LOCZ 12
						UDF_EXP_REF  ATTACH CSYS 0
					END_CREATE_UDF
					ASSEMBLE ASM_MDL ASSEM
						CSYS ATTACH PLACEMENT
					END_ASSEMBLE
					BUILD_INDEX++
				END_WHILE
				IF SUB_TYPE == "P"
				RETRIEVE_MDL "door_asm_2_"+SO_NUM+"_"+ITEM_NUM+".ASM" ASM_MDL
					SEARCH_MDL_REF ASM_MDL CSYS "*" PLACEMENT
					EXCEL_GET_VALUE 296	EXCEL_COLUMN	SHEET_QTY
					BUILD_INDEX = 1
					WHILE BUILD_INDEX <= SHEET_QTY
						CREATE_UDF udf\csys ASSEM
							UDF_REF ATTACH ATTACH
							UDF_DIM	ROTX 0
							UDF_DIM	ROTY 0
							UDF_DIM	ROTZ 0
							UDF_DIM	LOCX 0
							UDF_DIM	LOCY 0
							UDF_DIM	LOCZ 12
							UDF_EXP_REF  ATTACH CSYS 0
						END_CREATE_UDF
						ASSEMBLE ASM_MDL ASSEM
							CSYS ATTACH PLACEMENT
						END_ASSEMBLE
						BUILD_INDEX++
					END_WHILE
				END_IF
			END_IF
			BUILD_INDEX++
		END_IF
		EXCEL_COLUMN++
		EXCEL_GET_VALUE 0 EXCEL_COLUMN TEST_EOF
		IF TEST_EOF <> ""
			EOF = "FALSE"
		ELSE
			EOF = "TRUE"
		END_IF
	END_WHILE
	SAVE_MDL ASSEM
	WINDOW_CLOSE
	ERASE_NOT_DISPLAYED
	EXCEL_SAVE_DOCUMENT EXCEL_DOCUMENT_NAME
	EXCEL_DISCONNECT
END_IF

!REPLACE COMPONENTS

IF REPLACE_COMP == 1

	IF FRAMES_ == 1 AND FRAME_WO <> "99999"
		RETRIEVE_MDL "FRAMES_"+SO_NUM+"_"+FRAME_WO+".asm" ASSEM
	END_IF

	IF DOORS_ == 1 AND DOOR_WO <> "99999"
		RETRIEVE_MDL "DOORS_"+SO_NUM+"_"+DOOR_WO+".asm" ASSEM
	END_IF
	
	SEARCH_MDL_REFS RECURSIVE ASSEM COMPONENT "*" ALL_COMPONENTS

	FOR COMPONENT_TO_CHECK REF REVERSE_ARRAY ALL_COMPONENTS
		SEARCH_MDL_PARAM COMPONENT_TO_CHECK "STOCKTYPE" COMPONENT_STOCKTYPE
		IF COMPONENT_STOCKTYPE == 1
			GET_MDL_EXTENSION COMPONENT_TO_CHECK COMPONENT_EXTENSION
			IF COMPONENT_EXTENSION == "prt" OR COMPONENT_EXTENSION == "asm"
				GET_REF_PARENT COMPONENT_TO_CHECK  COMPONENT_PARENT
				SEARCH_MDL_PARAM COMPONENT_PARENT "STOCKTYPE" COMPONENT_PARENT_STOCKTYPE
				IF COMPONENT_PARENT_STOCKTYPE == 1 OR COMPONENT_PARENT_STOCKTYPE == 3
					GET_REF_GENERIC COMPONENT_TO_CHECK COMPONENT_GENERIC
					GET_REF_NAME COMPONENT_GENERIC COMPONENT_GENERIC_NAME
					GET_MDL_EXTENSION COMPONENT_GENERIC CG_EXT
					GET_REF_NAME COMPONENT_TO_CHECK COMPONENT_NAME
					GET_MDL_EXTENSION COMPONENT_TO_CHECK CTC_EXT
					IF COMPONENT_NAME+"."+CTC_EXT <> COMPONENT_GENERIC_NAME+"."+CG_EXT
						CLEAR_ARRAY COMPONENT_GENERIC_INSTANCE_NAMES
						GET_FAMINSTANCE_NAMES COMPONENT_GENERIC COMPONENT_GENERIC_INSTANCE_NAMES
						FOR INSTANCE_NAME REF ARRAY COMPONENT_GENERIC_INSTANCE_NAMES
							GET_REF_FAMINSTANCE COMPONENT_TO_CHECK INSTANCE_NAME INSTANCE_TO_CHECK
							IF INSTANCE_NAME == COMPONENT_NAME
								BREAK
							ELSE
								CLEAR_ARRAY GENERIC_ITEMS
								GET_FAMITEMS COMPONENT_GENERIC GENERIC_ITEMS
								MATCH = "YES"
								FOR ITEM REF ARRAY GENERIC_ITEMS
									IF ITEM == "CSYS_CHECK" OR ITEM == "STOCKTYPE" OR ITEME == "STOCKED" OR ITEM == "EMJACNUM" OR \
									   ITEM == "COMMENT" OR ITEM == "SINDEX" OR ITEM == "Common Name" OR ITEM == "USED" OR ITEM == "PDF"
									   MATCH = "YES"
									END_IF
									IF ITEM == "TYPE"
										GET_FAMITEM_VALUE COMPONENT_GENERIC INSTANCE_NAME ITEM INSTANCE_ITEM_VALUE
										GET_FAMITEM_VALUE COMPONENT_GENERIC COMPONENT_NAME ITEM COMPONENT_ITEM_VALUE
										IF COMPONENT_ITEM_VALUE == INSTANCE_ITEM_VALUE
											MATCH = "YES"
										ELSE
											MATCH = "NO"
										END_IF
									END_IF
									IF ITEM == "GRADE"
										GET_FAMITEM_VALUE COMPONENT_GENERIC INSTANCE_NAME ITEM INSTANCE_ITEM_VALUE
										GET_FAMITEM_VALUE COMPONENT_GENERIC COMPONENT_NAME ITEM COMPONENT_ITEM_VALUE
										IF COMPONENT_ITEM_VALUE == INSTANCE_ITEM_VALUE
											MATCH = "YES"
										ELSE
											MATCH = "NO"
										END_IF
									END_IF
									IF ITEM == "FINISH"
										GET_FAMITEM_VALUE COMPONENT_GENERIC INSTANCE_NAME ITEM INSTANCE_ITEM_VALUE
										GET_FAMITEM_VALUE COMPONENT_GENERIC COMPONENT_NAME ITEM COMPONENT_ITEM_VALUE
										IF COMPONENT_ITEM_VALUE == INSTANCE_ITEM_VALUE
											MATCH = "YES"
										ELSE
											MATCH = "NO"
										END_IF
									END_IF
								END_FOR
								IF MATCH == "YES"
									COMPARE_MDLS BY_SOLIDGEOMETRY COMPONENT_TO_CHECK INSTANCE_TO_CHECK IDENTICAL
									IF IDENTICAL == "TRUE"
										MATCH = "YES"
									ELSE
										MATCH = "NO"
									END_IF
								END_IF
								IF MATCH == "YES"
									GET_REF_GENERIC COMPONENT_PARENT COMPONENT_PARENT_GENERIC
									GET_REF_NAME COMPONENT_PARENT_GENERIC COMPONENT_PARENT_GENERIC_NAME
									GET_REF_NAME COMPONENT_PARENT COMPONENT_PARENT_NAME
									IF COMPONENT_PARENT_GENERIC_NAME == COMPONENT_PARENT_NAME
										REPLACE_COMPONENT COMPONENT_TO_CHECK INSTANCE_TO_CHECK
										REGEN_MDL ASSEM
										BREAK
									ELSE
										CLEAR_ARRAY GENERIC_ITEMS
										GET_FAMITEMS COMPONENT_PARENT_GENERIC GENERIC_ITEMS
										FOR ITEM REF ARRAY GENERIC_ITEMS
											GET_FAMITEM_VALUE COMPONENT_PARENT_GENERIC COMPONENT_PARENT_NAME ITEM ITEM_VALUE
											IF ITEM_VALUE == COMPONENT_NAME
												SET_FAMITEM_VALUE COMPONENT_PARENT_GENERIC COMPONENT_PARENT_NAME ITEM INSTANCE_NAME
												MATCH = "NO"
												REGEN_MDL ASSEM
											ELSE_IF GENERIC_ITEM == INSTANCE_NAME
												MATCH = "YES"
											END_IF
										END_FOR
									END_IF
								END_IF
							END_IF
						END_FOR
					END_IF
				END_IF
			END_IF
		END_IF
	END_FOR
	CLEAR_ARRAY ALL_COMPONENTS
	REGEN_MDL ASSEM
	SAVE_MDL ASSEM
	WINDOW_CLOSE
	ERASE_NOT_DISPLAYED
	! EXCEL_SAVE_DOCUMENT EXCEL_DOCUMENT_NAME
	! EXCEL_DISCONNECT
END_IF



!PART LISTING
IF PART_LIST == 1
	IF FRAMES_ == 1 AND FRAME_WO <> "99999"
		RETRIEVE_MDL "FRAMES_"+SO_NUM+"_"+FRAME_WO+".asm" ASSEM
		BOM_DOCUMENT_NAME = "C:\SIGMAXIM\Library\component_engine\SDI\BOM_TEMPLATE.xls"
		EXCEL_CONNECT
		EXCEL_LOAD_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
		EXCEL_SET_VALUE CELL_BY_NAME "A2" SO_NUM
		EXCEL_SET_VALUE CELL_BY_NAME "B2" FRAME_WO
		BOM_DOCUMENT_NAME = "BOM_"+FRAME_WO
		EXCEL_SAVE_DOCUMENT BOM_DOCUMENT_NAME
	END_IF

	IF DOORS_ == 1 AND DOOR_WO <> "99999"
		RETRIEVE_MDL "DOORS_"+SO_NUM+"_"+DOOR_WO+".asm" ASSEM
		BOM_DOCUMENT_NAME = "C:\SIGMAXIM\Library\component_engine\SDI\BOM_TEMPLATE.xls"
		EXCEL_CONNECT
		EXCEL_LOAD_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
		EXCEL_SET_VALUE CELL_BY_NAME "A2" SO_NUM
		EXCEL_SET_VALUE CELL_BY_NAME "B2" DOOR_WO
		BOM_DOCUMENT_NAME = "BOM_"+DOOR_WO
		EXCEL_SAVE_DOCUMENT BOM_DOCUMENT_NAME
	END_IF

	EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
	EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
	EXCEL_ROW = 5

	CLEAR_ARRAY ALL_COMPONENTS
	SEARCH_MDL_REFS ASSEM COMPONENT "*" ALL_COMPONENTS

	GET_ARRAY_SIZE ALL_COMPONENTS Size

	FOR EACH_COMPONENT REF ARRAY ALL_COMPONENTS
		GET_REF_NAME EACH_COMPONENT COMPONENT_NAME
		SEARCH_MDL_PARAM EACH_COMPONENT "STOCKTYPE" STOCKTYPE
		GET_MDL_EXTENSION EACH_COMPONENT EXTENSION

		IF STOCKTYPE == 1 AND EXTENSION == "prt"
			PROCESS_STATE = ""
			EXCEL_ROW = 5
			EXCEL_COMPONENT_NAME = ""

			WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
				EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
				IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
					EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
					EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + 1
				ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
					EXCEL_ROW++
				ELSE_IF EXCEL_COMPONENT_NAME == ""
					EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
					EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
					EXCEL_SET_VALUE EXCEL_ROW 3 1
					PROCESS_STATE = "DONE"
				END_IF
			END_WHILE
		ELSE_IF STOCKTYPE == 3
			PROCESS_STATE = ""
			EXCEL_ROW = 5
			EXCEL_COMPONENT_NAME = ""

			WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
				GET_MDL_TYPE EACH_COMPONENT MDLTYPE
				EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
				IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
					EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
					EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + 1
				ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
					EXCEL_ROW++
				ELSE_IF EXCEL_COMPONENT_NAME == ""
					EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
					EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
					EXCEL_SET_VALUE EXCEL_ROW 3 1
					EXCEL_SET_VALUE EXCEL_ROW 19 MDLTYPE
					PROCESS_STATE = "DONE"
				END_IF
			END_WHILE
		ELSE_IF STOCKTYPE == 4
			PROCESS_STATE = ""
			EXCEL_ROW = 5
			EXCEL_COMPONENT_NAME = ""

			GET_REF_GENERIC EACH_COMPONENT COMP_GENERIC
			GET_REF_NAME COMP_GENERIC GENERIC_NAME
			SEARCH_MDL_PARAM COMP_GENERIC "STOCKTYPE" STOCKTYPE
			GET_MDL_TYPE COMP_GENERIC MDLTYPE
			
			WHILE GENERIC_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
				EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
				IF GENERIC_NAME == EXCEL_COMPONENT_NAME
					EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
					EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + 1
				ELSE_IF GENERIC_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
					EXCEL_ROW++
				ELSE_IF EXCEL_COMPONENT_NAME == ""
					EXCEL_SET_VALUE EXCEL_ROW 1 GENERIC_NAME
					EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
					EXCEL_SET_VALUE EXCEL_ROW 3 1
					EXCEL_SET_VALUE EXCEL_ROW 19 MDLTYPE
					PROCESS_STATE = "DONE"
				END_IF
			END_WHILE			
		ELSE_IF STOCKTYPE == 1 AND EXTENSION == "asm"
			DECLARE_ARRAY SUB_COMPONENTS1
			CLEAR_ARRAY SUB_COMPONENTS1
			SEARCH_MDL_REFS EACH_COMPONENT COMPONENT "*" SUB_COMPONENTS1

			FOR SUB_COMPONENT1 REF ARRAY SUB_COMPONENTS1
				GET_REF_NAME SUB_COMPONENT1 COMPONENT_NAME
				SEARCH_MDL_PARAM SUB_COMPONENT1 "STOCKTYPE" STOCKTYPE
				GET_MDL_EXTENSION SUB_COMPONENT1 EXTENSION

				IF STOCKTYPE == 1 AND EXTENSION == "prt"
					PROCESS_STATE = ""
					EXCEL_ROW = 5
					EXCEL_COMPONENT_NAME = ""

					WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
						EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
						IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
							EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
							EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + 1
						ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
							EXCEL_ROW++
						ELSE_IF EXCEL_COMPONENT_NAME == ""
							EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
							EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
							EXCEL_SET_VALUE EXCEL_ROW 3 1
							PROCESS_STATE = "DONE"
						END_IF
					END_WHILE
				ELSE_IF STOCKTYPE == 3
					PROCESS_STATE = ""
					EXCEL_ROW = 5
					EXCEL_COMPONENT_NAME = ""

					WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
						GET_MDL_TYPE SUB_COMPONENT1 MDLTYPE1
						EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
						IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
							EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
							EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + 1
						ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
							EXCEL_ROW++
						ELSE_IF EXCEL_COMPONENT_NAME == ""
							EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
							EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
							EXCEL_SET_VALUE EXCEL_ROW 3 1
							EXCEL_SET_VALUE EXCEL_ROW 19 MDLTYPE1
							PROCESS_STATE = "DONE"
						END_IF
					END_WHILE
				ELSE_IF STOCKTYPE == 4
					PROCESS_STATE = ""
					EXCEL_ROW = 5
					EXCEL_COMPONENT_NAME = ""

					GET_REF_GENERIC SUB_COMPONENT1 COMP_GENERIC
					GET_REF_NAME COMP_GENERIC GENERIC_NAME
					SEARCH_MDL_PARAM COMP_GENERIC "STOCKTYPE" STOCKTYPE
					GET_MDL_TYPE COMP_GENERIC MDLTYPE
					
					WHILE GENERIC_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
						EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
						IF GENERIC_NAME == EXCEL_COMPONENT_NAME
							EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
							EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + 1
						ELSE_IF GENERIC_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
							EXCEL_ROW++
						ELSE_IF EXCEL_COMPONENT_NAME == ""
							EXCEL_SET_VALUE EXCEL_ROW 1 GENERIC_NAME
							EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
							EXCEL_SET_VALUE EXCEL_ROW 3 1
							EXCEL_SET_VALUE EXCEL_ROW 19 MDLTYPE
							PROCESS_STATE = "DONE"
						END_IF
					END_WHILE			
				ELSE_IF STOCKTYPE == 1 AND EXTENSION == "asm"
					DECLARE_ARRAY SUB_COMPONENTS2
					CLEAR_ARRAY SUB_COMPONENTS2
					SEARCH_MDL_REFS SUB_COMPONENT1 COMPONENT "*" SUB_COMPONENTS2

					FOR SUB_COMPONENT2 REF ARRAY SUB_COMPONENTS2
						GET_REF_NAME SUB_COMPONENT2 COMPONENT_NAME
						SEARCH_MDL_PARAM SUB_COMPONENT2 "STOCKTYPE" STOCKTYPE
						GET_MDL_EXTENSION SUB_COMPONENT2 EXTENSION

						IF STOCKTYPE == 1 AND EXTENSION == "prt"
							PROCESS_STATE = ""
							EXCEL_ROW = 5
							EXCEL_COMPONENT_NAME = ""

							WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
								EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
								IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
									EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
									EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + 1
								ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
									EXCEL_ROW++
								ELSE_IF EXCEL_COMPONENT_NAME == ""
									EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
									EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
									EXCEL_SET_VALUE EXCEL_ROW 3 1
									PROCESS_STATE = "DONE"
								END_IF
							END_WHILE
						ELSE_IF STOCKTYPE == 3
							PROCESS_STATE = ""
							EXCEL_ROW = 5
							EXCEL_COMPONENT_NAME = ""

							WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
								GET_MDL_TYPE SUB_COMPONENT2 MDLTYPE2
								EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
								IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
									EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
									EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + 1
								ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
									EXCEL_ROW++
								ELSE_IF EXCEL_COMPONENT_NAME == ""
									EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
									EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
									EXCEL_SET_VALUE EXCEL_ROW 3 1
									EXCEL_SET_VALUE EXCEL_ROW 19 MDLTYPE2
									PROCESS_STATE = "DONE"
								END_IF
							END_WHILE
						END_IF
					END_FOR
				END_IF
			END_FOR
		END_IF
	END_FOR


	!PART DETAIL INFORMATION AND DXF FROM PART LISTING
	EXCEL_ROW = 5
	EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
	EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
	EXCEL_GET_VALUE EXCEL_ROW 1 EXCEL_COMPONENT_NAME

	IF EXCEL_COMPONENT_NAME == ""
		EOF = "TRUE"
	ELSE
		EOF = "FALSE"
	END_IF

	WHILE EOF == "FALSE"
		EXCEL_GET_VALUE EXCEL_ROW 2 STOCKTYPE
		IF STOCKTYPE == 1
			EXCEL_GET_VALUE EXCEL_ROW 0 INDEX
			EXCEL_GET_VALUE EXCEL_ROW 4 THICKNESS
			EXCEL_GET_VALUE EXCEL_ROW 1 EXCEL_COMPONENT_NAME
			COMPONENT_NAME = EXCEL_COMPONENT_NAME+".prt"
			RETRIEVE_MDL COMPONENT_NAME DXF_COMP
			SEARCH_MDL_PARAM DXF_COMP "SHAPE" SHAPE
			CLEAR_ARRAY CSYS_ARRAY
			SEARCH_MDL_REFS DXF_COMP CSYS "*" CSYS_ARRAY
			CLEAR_ARRAY SURFACE_ARRAY
			SEARCH_MDL_REFS DXF_COMP SURFACE "*" SURFACE_ARRAY

			IF SHAPE == "SHEET" OR SHAPE == "SHEET_"
				DECLARE_VARIABLE INTEGER CSYS_QTY
				CSYS_QTY = 0
				FOR CSYS_REF REF ARRAY CSYS_ARRAY
					GET_REF_NAME CSYS_REF CSYS_NAME
					IF CSYS_NAME == "DIM"
						CSYS_QTY = CSYS_QTY + 1
					END_IF
				END_FOR

				IF CSYS_QTY < 1
					PRINT "THERE IS NO DIM CSYS FOR THIS PART"
					STOP
				END_IF

				SEARCH_MDL_REF DXF_COMP CSYS "*" REFCSYS
				SEARCH_MDL_PARAM DXF_COMP "THICKNESS" THICKNESS
				SEARCH_MDL_PARAM DXF_COMP "TYPE" TYPE
				SEARCH_MDL_PARAM DXF_COMP "GRADE" GRADE
				SEARCH_MDL_PARAM DXF_COMP "FINISH" FINISH
				SEARCH_MDL_PARAM DXF_COMP "GRAIN" GRAIN
				SEARCH_MDL_PARAM DXF_COMP "PVC" PVC
				SEARCH_MDL_PARAM DXF_COMP "DEBUR" DEBUR
				SEARCH_MDL_PARAM DXF_COMP "EMJACNUM" EMJACNUM

				CALC_OUTLINE REFCSYS DXF_COMP outline

				IF outline.x1 < outline.x2
					X = outline.x2 - outline.x1
				ELSE
					X = outline.x1 - outline.x2
				END_IF
					IF X < 0
						X = X*-1
					END_IF
				IF outline.y1 < outline.y2
					Y = outline.y2 - outline.y1
				ELSE
					Y = outline.y1 - outline.y2
				END_IF
					IF Y < 0
						Y = Y*-1
					END_IF
				IF outline.z1 < outline.z2
					Z = outline.z2 - outline.z1
				ELSE
					Z = outline.z1 - outline.z2
				END_IF
					IF Z < 0
						Z = Z*-1
					END_IF

				IF X > THICKNESS*1.25 AND Y > THICKNESS*1.25 AND Z > THICKNESS*1.25
					STATE = "FORMED"
				ELSE
					STATE = "FLAT"
				END_IF

				IF STATE == "FORMED"
					EXCEL_SET_VALUE EXCEL_ROW 19 "FORMED"
					DECLARE_VARIABLE INTEGER SURFACE_QTY
					SURFACE_QTY = 0
					FOR SURFACE_REF REF ARRAY SURFACE_ARRAY
						GET_REF_NAME SURFACE_REF SURFACE_NAME
						IF SURFACE_NAME == "FIXED"
							SURFACE_QTY = SURFACE_QTY + 1
						END_IF
					END_FOR

					IF SURFACE_QTY < 1
						PRINT "THERE IS NO FIXED SURFACE IN THIS PART"
						STOP
					END_IF

					! GET_REF_NAME DXF_COMP DXF_NAME
					! GET_REF_GENERIC DXF_COMP DXF_GENERIC
					! GET_REF_NAME DXF_GENERIC GENERIC_NAME

					SEARCH_MDL_REF DXF_COMP SURFACE "FIXED" FIRST_SURF
					CREATE_UDF lib:udf\unbend DXF_COMP
						UDF_REF surface FIRST_SURF
						UDF_EXP_REF FLAT FEATURE 0
					END_CREATE_UDF

					! IF DXF_NAME == GENERIC_NAME
						! SEARCH_MDL_REF DXF_COMP SURFACE "FIXED" FIRST_SURF
						! CREATE_UDF lib:udf\unbend DXF_COMP
							! UDF_REF surface FIRST_SURF
							! UDF_EXP_REF FLAT FEATURE 0
						! END_CREATE_UDF
					! END_IF

					! IF DXF_NAME <> GENERIC_NAME
						! SWITCH_TO_MDL DXF_GENERIC
						! SEARCH_MDL_REF DXF_GENERIC SURFACE "FIXED" FIRST_SURF
						! CREATE_UDF lib:udf\unbend DXF_GENERIC
							! UDF_REF surface FIRST_SURF
							! UDF_EXP_REF FLAT FEATURE 0
						! END_CREATE_UDF
						! SWITCH_TO_MDL DXF_COMP
						! REGEN_MDL DXF_COMP
						! WINDOW_CLOSE
					! END_IF
				ELSE
					EXCEL_SET_VALUE EXCEL_ROW 19 "FLAT"
					SET_MDL_PARAM DXF_COMP "COMMENT" "FLAT"
				END_IF

				SEARCH_MDL_REF DXF_COMP CSYS "DIM" REFCSYS
				CALC_OUTLINE_PARAM REFCSYS X_SIZE X
				CALC_OUTLINE_PARAM REFCSYS Y_SIZE Y
				CALC_OUTLINE_PARAM REFCSYS Z_SIZE Z

				LENGTH = X
				WIDTH = Y

				IF TYPE == "SS"
					TYPE = "1SS"
				ELSE_IF TYPE == "GALV"
					TYPE = "2GALV"
				END_IF

				SWIDTH = ftos(WIDTH,3)
				IF strlen(SWIDTH ) == 5
					SWIDTH = "00"+SWIDTH
				ELSE_IF strlen(SWIDTH ) == 6
					SWIDTH = "0"+SWIDTH
				END_IF

				SLENGTH = ftos(LENGTH,3)
				IF strlen(SLENGTH ) == 5
					SLENGTH = "00"+SLENGTH
				ELSE_IF strlen(SLENGTH) == 6
					SLENGTH = "0"+SLENGTH
				END_IF

				IF strlen(FINISH) == 1
					FINISH = "00"+FINISH
				ELSE_IF strlen(FINISH) == 2
					FINISH = "0"+FINISH
				END_IF


				EXCEL_SET_VALUE EXCEL_ROW 4 ftos(THICKNESS,3)
				EXCEL_SET_VALUE EXCEL_ROW 5 TYPE
				EXCEL_SET_VALUE EXCEL_ROW 6 GRADE
				EXCEL_SET_VALUE EXCEL_ROW 7 FINISH
				EXCEL_SET_VALUE EXCEL_ROW 8 SWIDTH
				EXCEL_SET_VALUE EXCEL_ROW 9 SLENGTH
				EXCEL_SET_VALUE EXCEL_ROW 10 itos(GRAIN)
				EXCEL_SET_VALUE EXCEL_ROW 11 itos(PVC)
				EXCEL_SET_VALUE EXCEL_ROW 12 itos(DEBUR)

				WINDOW_CLOSE
				ERASE_NOT_DISPLAYED					
				
				! IF STATE == "FORMED" AND DXF_NAME == GENERIC_NAME
					! SWITCH_TO_MDL DXF_COMP
					! REMOVE_FEATURE FLAT
				! ELSE_IF STATE == "FORMED" AND DXF_NAME <> GENERIC_NAME
					! SWITCH_TO_MDL DXF_GENERIC
					! REMOVE_FEATURE FLAT
					! REGEN_MDL DXF_GENERIC
					! SWITCH_TO_MDL DXF_COMP
				! END_IF
					! REGEN_MDL DXF_COMP
			END_IF
		ELSE_IF STOCKTYPE == 3
			EXCEL_GET_VALUE EXCEL_ROW 1 EXCEL_COMPONENT_NAME
			EXCEL_GET_VALUE EXCEL_ROW 19 MDLTYPE

			IF MDLTYPE == "PART"
				COMPONENT_NAME = EXCEL_COMPONENT_NAME+".prt"
			ELSE_IF MDLTYPE == "ASSEMBLY"
				COMPONENT_NAME = EXCEL_COMPONENT_NAME+".asm"
			END_IF
			RETRIEVE_MDL COMPONENT_NAME DXF_COMP
			SEARCH_MDL_PARAM DXF_COMP "EMJACNUM" EMJACNUM
			SEARCH_MDL_PARAM DXF_COMP "EMJACDESC" EMJACDESC
			EXCEL_SET_VALUE EXCEL_ROW 14 EMJACNUM
			EXCEL_SET_VALUE EXCEL_ROW 15 EMJACDESC
		END_IF

		EXCEL_ROW++
		EXCEL_GET_VALUE EXCEL_ROW 1 EXCEL_COMPONENT_NAME

		IF EXCEL_COMPONENT_NAME == ""
			EOF = "TRUE"
		ELSE
			EOF = "FALSE"
		END_IF
	END_WHILE

	DECLARE_ARRAY MACRO
	EXCEL_RUN_MACRO "macro1" MACRO

	EXCEL_SAVE_DOCUMENT BOM_DOCUMENT_NAME
	EXCEL_DISCONNECT
	WINDOW_CLOSE
	ERASE_NOT_DISPLAYED	
END_IF
	
	
IF EXPORT_DXF == 1
	EXCEL_CONNECT
	
	IF FRAMES_ == 1 AND FRAME_WO <> "99999"
		BOM_DOCUMENT_NAME = "BOM_"+FRAME_WO
		EXCEL_LOAD_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
	END_IF

	IF DOORS_ == 1 AND DOOR_WO <> "99999"
		BOM_DOCUMENT_NAME = "BOM_"+DOOR_WO
		EXCEL_LOAD_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
	END_IF

	DECLARE_ARRAY MACRO
	EXCEL_RUN_MACRO "macro1" MACRO

	!CREATE DXF - FLATS
	DISPLAY_DATUM PLANES FALSE
	DISPLAY_DATUM AXES FALSE
	DISPLAY_DATUM POINTS FALSE
	DISPLAY_DATUM CSYS FALSE

	DXF_DIRECTORY = PROJECT_DIRECTORY+\+WO_NUM
	CREATE_DIRECTORY DXF_DIRECTORY

	EXCEL_ROW = 5
	EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
	EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
	EXCEL_GET_VALUE EXCEL_ROW 1 EXCEL_COMPONENT_NAME

	IF EXCEL_COMPONENT_NAME == ""
		EOF = "TRUE"
	ELSE
		EOF = "FALSE"
	END_IF

	WHILE EOF == "FALSE"
		EXCEL_GET_VALUE EXCEL_ROW 2 STOCKTYPE
		IF STOCKTYPE == 1
			EXCEL_GET_VALUE EXCEL_ROW 0 INDEX

						SINDEX = itos(INDEX)
						IF strlen(SINDEX) == 1
							SINDEX = "00"+SINDEX
						ELSE_IF strlen(SINDEX) == 2
							SINDEX = "0"+SINDEX
						END_IF

			EXCEL_GET_VALUE EXCEL_ROW 1 EXCEL_COMPONENT_NAME
			COMPONENT_NAME = EXCEL_COMPONENT_NAME+".prt"
			
			RETRIEVE_MDL COMPONENT_NAME DXF_COMP
			SET_MDL_PARAM DXF_COMP "EMJACNUM" SINDEX+"_"+WO_NUM
			SET_MDL_PARAM DXF_COMP "USED" 1
			SET_MDL_PARAM DXF_COMP "WO_NUM" WO_NUM
			
			REGEN_MDL DXF_COMP			
			SAVE_MDL DXF_COMP
			SEARCH_MDL_PARAM DXF_COMP "SHAPE" SHAPE
			SEARCH_MDL_PARAM DXF_COMP "GRAIN" GRAIN

			IF SHAPE == "SHEET"
				EXCEL_GET_VALUE EXCEL_ROW 19 STATE
				EXCEL_GET_VALUE EXCEL_ROW 0 INDEX
					SINDEX = itos(INDEX)
					IF strlen(SINDEX) == 1
						SINDEX = "00"+SINDEX
					ELSE_IF strlen(SINDEX) == 2
						SINDEX = "0"+SINDEX
					END_IF
					
				IF STATE == "FORMED"
					SEARCH_MDL_REF DXF_COMP SURFACE "FIXED" FIRST_SURF
					CREATE_UDF lib:udf\unbend DXF_COMP
						UDF_REF surface FIRST_SURF
						UDF_EXP_REF FLAT FEATURE 0
					END_CREATE_UDF
				END_IF
				
				! IF STATE == "FORMED"
					! GET_REF_NAME DXF_COMP DXF_NAME
					! GET_REF_GENERIC DXF_COMP DXF_GENERIC
					! GET_REF_NAME DXF_GENERIC GENERIC_NAME

					! IF DXF_NAME == GENERIC_NAME
						! SEARCH_MDL_REF DXF_COMP SURFACE "FIXED" FIRST_SURF
						! CREATE_UDF lib:udf\unbend DXF_COMP
							! UDF_REF surface FIRST_SURF
							! UDF_EXP_REF FLAT FEATURE 0
						! END_CREATE_UDF
					! END_IF

					! IF DXF_NAME <> GENERIC_NAME
						! SWITCH_TO_MDL DXF_GENERIC
						! SEARCH_MDL_REF DXF_GENERIC SURFACE "FIXED" FIRST_SURF
						! CREATE_UDF lib:udf\unbend DXF_GENERIC
							! UDF_REF surface FIRST_SURF
							! UDF_EXP_REF FLAT FEATURE 0
						! END_CREATE_UDF
						! SWITCH_TO_MDL DXF_COMP
						! REGEN_MDL DXF_COMP
						! ! WINDOW_CLOSE
					! END_IF
				! END_IF

				USE_LIBRARY_MDL lib:dxf_temp DRAWING DXF
				CREATE_DRW_VIEW_GENERAL dxf DXF_COMP itos(GRAIN) 1 60 36 0 dxfView
				SET_DRW_VIEW_TANGENT_EDGE_DISPLAY dxfView NONE
				SET_DRW_VIEW_DISPLAY dxfView NO_HIDDEN
				SET_WORKING_DIRECTORY DXF_DIRECTORY
				EXPORT_FILE dxf DXF WO_NUM +"_"+ SINDEX
				SET_WORKING_DIRECTORY PROJECT_DIRECTORY

			WINDOW_CLOSE
			ERASE_NOT_DISPLAYED
			END_IF
		END_IF

		EXCEL_ROW++
		EXCEL_GET_VALUE EXCEL_ROW 1 EXCEL_COMPONENT_NAME

		IF EXCEL_COMPONENT_NAME == ""
			EOF = "TRUE"
		ELSE
			EOF = "FALSE"
		END_IF
	END_WHILE
	
	WINDOW_CLOSE
	ERASE_NOT_DISPLAYED
	EXCEL_DISCONNECT
END_IF

IF REQUISITIONS == 1
	!CREATE MATERIAL REQUISITION
	RETRIEVE_MDL WO_ASSEM.ASM ASSEM
	
	IF FRAMES_ == 1 AND FRAME_WO <> "99999"
		SET_MDL_NAME ASSEM "FRAMES_"+FRAME_WO
		BOM_DOCUMENT_NAME = "BOM_"+FRAME_WO
	END_IF

	IF DOORS_ == 1 AND DOOR_WO <> "99999"
		SET_MDL_NAME ASSEM "DOORS_"+DOOR_WO
		BOM_DOCUMENT_NAME = "BOM_"+DOOR_WO
	END_IF
	
	IF DOOR_WO <> "99999" AND FRAME_WO == "99999"
		ITEM_DESC = "DOORS"
	END_IF
	
	IF DOOR_WO == "99999" AND FRAME_WO <> "99999"
		ITEM_DESC = "FRAMES"
	END_IF

	IF DOOR_WO <> "99999" AND FRAME_WO <> "99999"
		ITEM_DESC = "DOOR AND FRAMES"
	END_IF	
		
		EXCEL_CONNECT
		EXCEL_LOAD_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
		EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
	
	CREATE_DRW ASSEM req_template.drw refDrawing

	EXCEL_ROW = 5
	EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
	EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
	EXCEL_GET_VALUE EXCEL_ROW 1 EXCEL_COMPONENT_NAME

	IF EXCEL_COMPONENT_NAME == ""
		EOF = "TRUE"
	ELSE
		EOF = "FALSE"
	END_IF

	IF EXCEL_COMPONENT_NAME <> ""
		EOF = "FALSE"
		WHILE EOF == "FALSE"
			EXCEL_ROW++
			EXCEL_GET_VALUE EXCEL_ROW 1 EXCEL_COMPONENT_NAME
			IF EXCEL_COMPONENT_NAME == ""
				EOF = "TRUE"
			ELSE
				EOF = "FALSE"
			END_IF
		END_WHILE

		EXCEL_GET_VALUES CELL_BY_INDEX 5 0 CELL_BY_INDEX (EXCEL_ROW-1) 19 arrayData

		DECLARE_ARRAY data
		DECLARE_ARRAY ITEMS

		FOR data REF ARRAY arrayData
			GET_ARRAY_ELEM data 2 value
			ADD_ARRAY_ELEM ITEMS value
		END_FOR

		GET_ARRAY_SIZE ITEMS SIZE

		SWITCH_TO_MDL refDrawing

		ERASE_NOT_DISPLAYED

		DECLARE_VARIABLE INTEGER ITP
		DECLARE_VARIABLE INTEGER ITEM_INDEX
		DECLARE_VARIABLE INTEGER MAX_LINES 26
		DECLARE_VARIABLE INTEGER TEMPD
		DECLARE_VARIABLE INTEGER TEMPN
		DECLARE_VARIABLE INTEGER NUMBER
		DECLARE_VARIABLE INTEGER DENOMENATOR 16
		DECLARE_VARIABLE INTEGER QTY
		DECLARE_VARIABLE INTEGER LINE_INDEX
		DECLARE_VARIABLE STRING MAT_NUM
		DECLARE_VARIABLE STRING MAT_DESC
		DECLARE_VARIABLE INTEGER SHEET_INDEX
		DECLARE_VARIABLE INTEGER TOTAL_SHEETS
		DECLARE_VARIABLE INTEGER SHEET
		DECLARE_VARIABLE STRING ADDED_LINES

		ITP = SIZE/20
		ITEM_INDEX = 1
		SHEET_INDEX = 0
		MAT_NUM = "XXX"
		ADDED_LINES = "NO"
		GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+2) STOCKTYPE
		GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+13) SHAPE2

		!CREATE MATERIAL REQUISITION SHEETS

		WHILE ITEM_INDEX <= ITP AND STOCKTYPE == 1 AND SHAPE2 == "1*"
			SHEET_INDEX++
			SHEET = SHEET_INDEX
			LINE_INDEX = 1
			IF SHEET_INDEX == 1
				SET_DRW_FORMAT refDrawing SHEET_INDEX material_req_format.frm
				CREATE_DRW_TABLE refDrawing ASSEM 1 .4375 6.625  "lib:mat_body.tbl"  BODY
			ELSE_IF SHEET_INDEX > 1
				INSERT_DRW_SHEET refDrawing SHEET_INDEX
				SET_DRW_CUR_SHEET refDrawing SHEET_INDEX
				SET_DRW_FORMAT refDrawing SHEET_INDEX material_req_format.frm
				CREATE_DRW_TABLE refDrawing ASSEM SHEET_INDEX .4375 6.625  "lib:mat_body.tbl"  BODY
			END_IF

			CREATE_DRW_NOTE refDrawing 1.0625 7.6875 WO_NUM
			CREATE_DRW_NOTE refDrawing 2.8125 7.6875 "&todays_date" HORIZONTAL CENTER

			IF CUSTOMER_NAME == ""
				PRINT "ENTER CUSTOMER NAME"
				USER_INPUT_PARAM STRING CUSTOMER_NAME
			END_IF
			CREATE_DRW_NOTE refDrawing 1.9375 7.125 CUSTOMER_NAME HORIZONTAL CENTER

			IF JOB_NAME == ""
				PRINT "ENTER JOB/PROJECT NAME"
				USER_INPUT_PARAM STRING JOB_NAME
			END_IF

			IF SUB_JOB_NAME == ""
				PRINT "ENTER SUB_JOB NAME"
				USER_INPUT_PARAM STRING SUB_JOB_NAME
			END_IF

			IF SUB_JOB_NAME == ""
				CREATE_DRW_NOTE refDrawing 5.5 7.125 JOB_NAME HORIZONTAL CENTER
			ELSE
				CREATE_DRW_NOTE refDrawing 5.5 7.209 JOB_NAME HORIZONTAL CENTER
				CREATE_DRW_NOTE refDrawing 5.5 7.042 SUB_JOB_NAME HORIZONTAL CENTER
			END_IF

			CREATE_DRW_NOTE refDrawing 9.5 7.9375 itos(SHEET)

			! IF ITEM_NUM == ""
				! PRINT "ENTER ITEM NUMBER"
				! USER_INPUT_PARAM STRING ITEM_NUM
			! END_IF
			! CREATE_DRW_NOTE refDrawing 8.125 7.6875 ITEM_NUM

			CREATE_DRW_NOTE refDrawing 9.0625 7.125 ITEM_DESC HORIZONTAL CENTER

			WHILE ITEM_INDEX <= ITP AND LINE_INDEX <= MAX_LINES AND SHAPE2 == "1*"
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MatNum
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+13) SHAPE2
				IF LINE_INDEX == 1
					GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MAT_NUM
					GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+15) MAT_DESC
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 1 MAT_NUM+"  -  "+MAT_DESC
					SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 1 HORIZONTAL CENTER VERTICAL MIDDLE
					LINE_INDEX = LINE_INDEX + 1
					ADDED_LINES = "YES"
				END_IF
				
				IF MAT_NUM <> MatNum AND SHAPE2 == "1*"
					IF LINE_INDEX > 1 AND LINE_INDEX <= MAX_LINES - 4
						MERGE_DRW_TABLE refDrawing BODY LINE_INDEX 1 LINE_INDEX 8
						LINE_INDEX = LINE_INDEX + 1
						MERGE_DRW_TABLE refDrawing BODY LINE_INDEX 1 LINE_INDEX 8
						GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MAT_NUM
						GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+15) MAT_DESC
						SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 1 MAT_NUM+"  -  "+MAT_DESC
						SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 1 HORIZONTAL CENTER VERTICAL MIDDLE
						LINE_INDEX = LINE_INDEX + 1
						ADDED_LINES = "YES"
					ELSE_IF LINE_INDEX > 1 AND LINE_INDEX > MAX_LINES - 4
						LINE_INDEX = MAX_LINES + 1
						BREAK
					END_IF
				END_IF
								
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+0) INDEX

				SINDEX = itos(INDEX)
				IF strlen(SINDEX) == 1
					SINDEX = "00"+SINDEX
				ELSE_IF strlen(SINDEX) == 2
					SINDEX = "0"+SINDEX
				END_IF


				SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 1 SINDEX
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 1 HORIZONTAL CENTER VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+1) DESC
				SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 2 DESC
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 2 VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+3) QTY
				SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 3 itos(QTY)
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 3 HORIZONTAL CENTER VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+8) SWIDTH
					WIDTH = stof(SWIDTH)
					TEMPD = 1/DENOMENATOR
					TEMPN = ROUND((WIDTH / TEMPD),0)
					NUMBER = FLOOR(TEMPN / DENOMENATOR)
					TEMPN = TEMPN - (NUMBER*DENOMENATOR)
					TEMPD = DENOMENATOR
					WHILE MOD(TEMPN,2) == 0 AND MOD(TEMPD,2) == 0
						TEMPN = TEMPN/2
						TEMPD = TEMPD/2
					END_WHILE

					IF NUMBER > 0 AND TEMPN > 0
						SWIDTH = itos(NUMBER) +"-"+ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					ELSE_IF NUMBER > 0 AND TEMPN == 0
						SWIDTH = itos(NUMBER)
					ELSE
						SWIDTH = ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+9) SLENGTH
					LENGTH = stof(SLENGTH)
					TEMPD = 1/DENOMENATOR
					TEMPN = ROUND((LENGTH / TEMPD),0)
					NUMBER = FLOOR(TEMPN / DENOMENATOR)
					TEMPN = TEMPN - (NUMBER*DENOMENATOR)
					TEMPD = DENOMENATOR
					WHILE MOD(TEMPN,2) == 0 AND MOD(TEMPD,2) == 0
						TEMPN = TEMPN/2
						TEMPD = TEMPD/2
					END_WHILE

					IF NUMBER > 0 AND TEMPN > 0
						SLENGTH = itos(NUMBER) +"-"+ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					ELSE_IF NUMBER > 0 AND TEMPN == 0
						SLENGTH = itos(NUMBER)
					ELSE
						SLENGTH = ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+10) GRAIN
				IF GRAIN == "0"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 5 "  "+SWIDTH+"   x   "+SLENGTH
				ELSE_IF GRAIN == "1"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 5 "  "+SWIDTH+"   x   "+SLENGTH+"  **"
				ELSE_IF GRAIN == "2"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 5 "  "+SLENGTH+"   x   "+SWIDTH+"  **"
				END_IF
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 5 VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+11) PVC
				IF PVC <> "0"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 6 "*"
				END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+12) DEBUR
				IF DEBUR <> "0"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 7 "*"
				END_IF				

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+19) STATE
				IF STATE == "FLAT"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 8 "FLAT"
				END_IF

				LINE_INDEX++
				ITEM_INDEX++
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+13) SHAPE2
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+2) STOCKTYPE
			END_WHILE
		END_WHILE

		!CREATE MATERIAL REQUISITION SHAPES

		WHILE ITEM_INDEX <= ITP AND SHAPE2 == "2*"
			SHEET_INDEX++
			SHEET = SHEET_INDEX
			LINE_INDEX = 1
			IF SHEET_INDEX == 1
				SET_DRW_FORMAT refDrawing SHEET_INDEX material_req_format.frm
				CREATE_DRW_TABLE refDrawing ASSEM 1 .4375 6.625  "lib:mat_body.tbl"  BODY
			ELSE_IF SHEET_INDEX > 1
				INSERT_DRW_SHEET refDrawing SHEET_INDEX
				SET_DRW_CUR_SHEET refDrawing SHEET_INDEX
				SET_DRW_FORMAT refDrawing SHEET_INDEX material_req_format.frm
				CREATE_DRW_TABLE refDrawing ASSEM SHEET_INDEX .4375 6.625  "lib:mat_body.tbl"  BODY
			END_IF

			CREATE_DRW_NOTE refDrawing 1.0625 7.6875 WO_NUM
			CREATE_DRW_NOTE refDrawing 2.8125 7.6875 "&todays_date" HORIZONTAL CENTER

			IF CUSTOMER_NAME == ""
				PRINT "ENTER CUSTOMER NAME"
				USER_INPUT_PARAM STRING CUSTOMER_NAME
			END_IF
			CREATE_DRW_NOTE refDrawing 1.9375 7.125 CUSTOMER_NAME HORIZONTAL CENTER

			IF JOB_NAME == ""
				PRINT "ENTER JOB/PROJECT NAME"
				USER_INPUT_PARAM STRING JOB_NAME
			END_IF

			IF SUB_JOB_NAME == ""
				PRINT "ENTER SUB_JOB NAME"
				USER_INPUT_PARAM STRING SUB_JOB_NAME
			END_IF

			IF SUB_JOB_NAME == ""
				CREATE_DRW_NOTE refDrawing 5.5 7.125 JOB_NAME HORIZONTAL CENTER
			ELSE
				CREATE_DRW_NOTE refDrawing 5.5 7.209 JOB_NAME HORIZONTAL CENTER
				CREATE_DRW_NOTE refDrawing 5.5 7.042 SUB_JOB_NAME HORIZONTAL CENTER
			END_IF

			CREATE_DRW_NOTE refDrawing 9.5 7.9375 itos(SHEET)

			! IF ITEM_NUM == ""
				! PRINT "ENTER ITEM NUMBER"
				! USER_INPUT_PARAM STRING ITEM_NUM
			! END_IF
			! CREATE_DRW_NOTE refDrawing 8.125 7.6875 ITEM_NUM
			
			CREATE_DRW_NOTE refDrawing 9.0625 7.125 ITEM_DESC HORIZONTAL CENTER

			WHILE ITEM_INDEX <= ITP AND LINE_INDEX <= MAX_LINES AND SHAPE2 == "2*"
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MatNuM
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+13) SHAPE2
				IF LINE_INDEX == 1
					GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MAT_NUM
					GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+15) MAT_DESC
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 1 MAT_NUM+"  -  "+MAT_DESC
					SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 1 HORIZONTAL CENTER VERTICAL MIDDLE
					LINE_INDEX = LINE_INDEX + 1
					ADDED_LINES = "YES"
				END_IF
				IF MAT_NUM <> MatNum AND SHAPE2 == "2*"
					IF LINE_INDEX > 1 AND LINE_INDEX <= MAX_LINES - 4
						MERGE_DRW_TABLE refDrawing BODY LINE_INDEX 1 LINE_INDEX 8
						LINE_INDEX = LINE_INDEX + 1
						MERGE_DRW_TABLE refDrawing BODY LINE_INDEX 1 LINE_INDEX 8
						GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MAT_NUM
						GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+15) MAT_DESC
						SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 1 MAT_NUM+"  -  "+MAT_DESC
						SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 1 HORIZONTAL CENTER VERTICAL MIDDLE
						LINE_INDEX = LINE_INDEX + 1
						ADDED_LINES = "YES"
					ELSE_IF LINE_INDEX > 1 AND LINE_INDEX > MAX_LINES - 4
						LINE_INDEX = MAX_LINES+1
					END_IF
				END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+0) INDEX

				SINDEX = itos(INDEX)
				IF strlen(SINDEX) == 1
					SINDEX = "00"+SINDEX
				ELSE_IF strlen(SINDEX) == 2
					SINDEX = "0"+SINDEX
				END_IF

				SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 1 SINDEX
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 1 HORIZONTAL CENTER VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+1) DESC
				SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 2 DESC
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 2 VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+3) QTY
				SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 3 itos(QTY)
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 3 HORIZONTAL CENTER VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+8) SWIDTH
					WIDTH = stof(SWIDTH)
					TEMPD = 1/DENOMENATOR
					TEMPN = ROUND((WIDTH / TEMPD),0)
					NUMBER = FLOOR(TEMPN / DENOMENATOR)
					TEMPN = TEMPN - (NUMBER*DENOMENATOR)
					TEMPD = DENOMENATOR
					WHILE MOD(TEMPN,2) == 0 AND MOD(TEMPD,2) == 0
						TEMPN = TEMPN/2
						TEMPD = TEMPD/2
					END_WHILE

					IF NUMBER > 0 AND TEMPN > 0
						SWIDTH = itos(NUMBER) +"-"+ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					ELSE_IF NUMBER > 0 AND TEMPN == 0
						SWIDTH = itos(NUMBER)
					ELSE
						SWIDTH = ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+9) SLENGTH
					LENGTH = stof(SLENGTH)
					TEMPD = 1/DENOMENATOR
					TEMPN = ROUND((LENGTH / TEMPD),0)
					NUMBER = FLOOR(TEMPN / DENOMENATOR)
					TEMPN = TEMPN - (NUMBER*DENOMENATOR)
					TEMPD = DENOMENATOR
					WHILE MOD(TEMPN,2) == 0 AND MOD(TEMPD,2) == 0
						TEMPN = TEMPN/2
						TEMPD = TEMPD/2
					END_WHILE

					IF NUMBER > 0 AND TEMPN > 0
						SLENGTH = itos(NUMBER) +"-"+ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					ELSE_IF NUMBER > 0 AND TEMPN == 0
						SLENGTH = itos(NUMBER)
					ELSE
						SLENGTH = ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+10) GRAIN
				IF GRAIN == "0"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 5 "  "+SWIDTH+"   x   "+SLENGTH
				ELSE_IF GRAIN == "1"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 5 "  "+SWIDTH+"   x   "+SLENGTH+"  **"
				ELSE_IF GRAIN == "2"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 5 "  "+SLENGTH+"   x   "+SWIDTH+"  **"
				END_IF
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 5 VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+11) PVC
				IF PVC <> "0"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 6 "*"
				END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+12) DEBUR
				IF DEBUR <> "0"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 7 "*"
				END_IF				
				
				LINE_INDEX++
				ITEM_INDEX++
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+13) SHAPE2
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+2) STOCKTYPE
			END_WHILE
		END_WHILE

		!CREATE MATERIAL REQUISITION FOAM & WOOD

		WHILE ITEM_INDEX <= ITP AND SHAPE2 == "3*"
			SHEET_INDEX++
			SHEET = SHEET_INDEX
			LINE_INDEX = 1
			IF SHEET_INDEX == 1
				SET_DRW_FORMAT refDrawing SHEET_INDEX material_req_format.frm
				CREATE_DRW_TABLE refDrawing ASSEM 1 .4375 6.625  "lib:mat_body.tbl"  BODY
			ELSE_IF SHEET_INDEX > 1
				INSERT_DRW_SHEET refDrawing SHEET_INDEX
				SET_DRW_CUR_SHEET refDrawing SHEET_INDEX
				SET_DRW_FORMAT refDrawing SHEET_INDEX material_req_format.frm
				CREATE_DRW_TABLE refDrawing ASSEM SHEET_INDEX .4375 6.625  "lib:mat_body.tbl"  BODY
			END_IF

			CREATE_DRW_NOTE refDrawing 1.0625 7.6875 WO_NUM
			CREATE_DRW_NOTE refDrawing 2.8125 7.6875 "&todays_date" HORIZONTAL CENTER

			IF CUSTOMER_NAME == ""
				PRINT "ENTER CUSTOMER NAME"
				USER_INPUT_PARAM STRING CUSTOMER_NAME
			END_IF
			CREATE_DRW_NOTE refDrawing 1.9375 7.125 CUSTOMER_NAME HORIZONTAL CENTER

			IF JOB_NAME == ""
				PRINT "ENTER JOB/PROJECT NAME"
				USER_INPUT_PARAM STRING JOB_NAME
			END_IF

			IF SUB_JOB_NAME == ""
				PRINT "ENTER SUB_JOB NAME"
				USER_INPUT_PARAM STRING SUB_JOB_NAME
			END_IF

			IF SUB_JOB_NAME == ""
				CREATE_DRW_NOTE refDrawing 5.5 7.125 JOB_NAME HORIZONTAL CENTER
			ELSE
				CREATE_DRW_NOTE refDrawing 5.5 7.209 JOB_NAME HORIZONTAL CENTER
				CREATE_DRW_NOTE refDrawing 5.5 7.042 SUB_JOB_NAME HORIZONTAL CENTER
			END_IF

			CREATE_DRW_NOTE refDrawing 9.5 7.9375 itos(SHEET)

			! IF ITEM_NUM == ""
				! PRINT "ENTER ITEM NUMBER"
				! USER_INPUT_PARAM STRING ITEM_NUM
			! END_IF
			! CREATE_DRW_NOTE refDrawing 8.125 7.6875 ITEM_NUM
			
			CREATE_DRW_NOTE refDrawing 9.0625 7.125 ITEM_DESC HORIZONTAL CENTER

			WHILE ITEM_INDEX <= ITP AND LINE_INDEX <= MAX_LINES AND SHAPE2 == "3*"
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MatNuM
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+13) SHAPE2
				IF LINE_INDEX == 1
					GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MAT_NUM
					GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+15) MAT_DESC
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 1 MAT_NUM+"  -  "+MAT_DESC
					SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 1 HORIZONTAL CENTER VERTICAL MIDDLE
					LINE_INDEX = LINE_INDEX + 1
					ADDED_LINES = "YES"
				END_IF
				IF MAT_NUM <> MatNum AND SHAPE2 == "3*"
					IF LINE_INDEX > 1 AND LINE_INDEX <= MAX_LINES - 4
						MERGE_DRW_TABLE refDrawing BODY LINE_INDEX 1 LINE_INDEX 8
						LINE_INDEX = LINE_INDEX + 1
						MERGE_DRW_TABLE refDrawing BODY LINE_INDEX 1 LINE_INDEX 8
						GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MAT_NUM
						GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+15) MAT_DESC
						SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 1 MAT_NUM+"  -  "+MAT_DESC
						SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 1 HORIZONTAL CENTER VERTICAL MIDDLE
						LINE_INDEX = LINE_INDEX + 1
						ADDED_LINES = "YES"
					ELSE_IF LINE_INDEX > 1 AND LINE_INDEX > MAX_LINES - 4
						LINE_INDEX = MAX_LINES+1
					END_IF
				END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+0) INDEX

				SINDEX = itos(INDEX)
				IF strlen(SINDEX) == 1
					SINDEX = "00"+SINDEX
				ELSE_IF strlen(SINDEX) == 2
					SINDEX = "0"+SINDEX
				END_IF

				SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 1 SINDEX
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 1 HORIZONTAL CENTER VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+1) DESC
				SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 2 DESC
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 2 VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+3) QTY
				SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 3 itos(QTY)
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 3 HORIZONTAL CENTER VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+8) SWIDTH
					WIDTH = stof(SWIDTH)
					TEMPD = 1/DENOMENATOR
					TEMPN = ROUND((WIDTH / TEMPD),0)
					NUMBER = FLOOR(TEMPN / DENOMENATOR)
					TEMPN = TEMPN - (NUMBER*DENOMENATOR)
					TEMPD = DENOMENATOR
					WHILE MOD(TEMPN,2) == 0 AND MOD(TEMPD,2) == 0
						TEMPN = TEMPN/2
						TEMPD = TEMPD/2
					END_WHILE

					IF NUMBER > 0 AND TEMPN > 0
						SWIDTH = itos(NUMBER) +"-"+ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					ELSE_IF NUMBER > 0 AND TEMPN == 0
						SWIDTH = itos(NUMBER)
					ELSE
						SWIDTH = ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+9) SLENGTH
					LENGTH = stof(SLENGTH)
					TEMPD = 1/DENOMENATOR
					TEMPN = ROUND((LENGTH / TEMPD),0)
					NUMBER = FLOOR(TEMPN / DENOMENATOR)
					TEMPN = TEMPN - (NUMBER*DENOMENATOR)
					TEMPD = DENOMENATOR
					WHILE MOD(TEMPN,2) == 0 AND MOD(TEMPD,2) == 0
						TEMPN = TEMPN/2
						TEMPD = TEMPD/2
					END_WHILE

					IF NUMBER > 0 AND TEMPN > 0
						SLENGTH = itos(NUMBER) +"-"+ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					ELSE_IF NUMBER > 0 AND TEMPN == 0
						SLENGTH = itos(NUMBER)
					ELSE
						SLENGTH = ftos(TEMPN,0)+"/"+ftos(TEMPD,0)
					END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+10) GRAIN
				IF GRAIN == "0"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 5 "  "+SWIDTH+"   x   "+SLENGTH
				ELSE_IF GRAIN == "1"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 5 "  "+SWIDTH+"   x   "+SLENGTH+"  **"
				ELSE_IF GRAIN == "2"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 5 "  "+SLENGTH+"   x   "+SWIDTH+"  **"
				END_IF
				SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 5 VERTICAL MIDDLE HEIGHT .1

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+11) PVC
				IF PVC <> "0"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 6 "*"
				END_IF

				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+12) DEBUR
				IF DEBUR <> "0"
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 7 "*"
				END_IF

				LINE_INDEX++
				ITEM_INDEX++
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+13) SHAPE2
				GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+2) STOCKTYPE
			END_WHILE
		END_WHILE

		IF SHEET_INDEX > 0
			TOTAL_SHEETS = SHEET_INDEX
			SHEET_INDEX = 1
			WHILE SHEET_INDEX <= TOTAL_SHEETS
				SET_DRW_CUR_SHEET refDrawing SHEET_INDEX
				CREATE_DRW_NOTE refDrawing 10.125 7.9375 itos(TOTAL_SHEETS)
				SHEET_INDEX++
			END_WHILE
		END_IF


		!CREATE STOCK REQUISITION

		SHEET_INDEX = TOTAL_SHEETS
		MAX_LINES = 26


		IF ITEM_INDEX <= ITP AND STOCKTYPE == 3
			WHILE ITEM_INDEX <= ITP AND STOCKTYPE == 3
				SHEET_INDEX++
				SHEET = SHEET_INDEX - TOTAL_SHEETS
				LINE_INDEX = 1

				INSERT_DRW_SHEET refDrawing SHEET_INDEX
				SET_DRW_CUR_SHEET refDrawing SHEET_INDEX
				SET_DRW_FORMAT refDrawing SHEET_INDEX stock_req_format.frm
				CREATE_DRW_TABLE refDrawing ASSEM SHEET_INDEX .4375 6.625  "lib:stock_body.tbl"  BODY

				CREATE_DRW_NOTE refDrawing 1.0625 7.6875 WO_NUM
				CREATE_DRW_NOTE refDrawing 2.8125 7.6875 "&todays_date" HORIZONTAL CENTER

				IF CUSTOMER_NAME == ""
					PRINT "ENTER CUSTOMER NAME"
					USER_INPUT_PARAM STRING CUSTOMER_NAME
				END_IF
				CREATE_DRW_NOTE refDrawing 1.9375 7.125 CUSTOMER_NAME HORIZONTAL CENTER

				IF JOB_NAME == ""
					PRINT "ENTER JOB/PROJECT NAME"
					USER_INPUT_PARAM STRING JOB_NAME
				END_IF

				IF SUB_JOB_NAME == ""
					PRINT "ENTER SUB_JOB NAME"
					USER_INPUT_PARAM STRING SUB_JOB_NAME
				END_IF

				IF SUB_JOB_NAME == ""
					CREATE_DRW_NOTE refDrawing 5.5 7.125 JOB_NAME HORIZONTAL CENTER
				ELSE
					CREATE_DRW_NOTE refDrawing 5.5 7.209 JOB_NAME HORIZONTAL CENTER
					CREATE_DRW_NOTE refDrawing 5.5 7.042 SUB_JOB_NAME HORIZONTAL CENTER
				END_IF

				CREATE_DRW_NOTE refDrawing 9.5 7.9375 itos(SHEET)

				! IF ITEM_NUM == ""
					! PRINT "ENTER ITEM NUMBER"
					! USER_INPUT_PARAM STRING ITEM_NUM
				! END_IF
				! CREATE_DRW_NOTE refDrawing 8.125 7.6875 ITEM_NUM
				
				CREATE_DRW_NOTE refDrawing 9.0625 7.125 ITEM_DESC HORIZONTAL CENTER

				WHILE ITEM_INDEX <= ITP AND LINE_INDEX <= MAX_LINES

					GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+15) EMJACDESC
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 2 EMJACDESC
					SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 2 VERTICAL MIDDLE HEIGHT .1

					GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+14) MatNuM
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 3 MatNum
					SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 3 HORIZONTAL CENTER VERTICAL MIDDLE HEIGHT .1

					GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+3) QTY
					SET_DRW_TABLE_TEXT refDrawing BODY LINE_INDEX 4 itos(QTY)
					SET_DRW_TABLE_FORMAT refDrawing BODY LINE_INDEX 4 HORIZONTAL CENTER VERTICAL MIDDLE HEIGHT .1

					LINE_INDEX++
					ITEM_INDEX++

					IF ITEM_INDEX < ITP
						GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+13) SHAPE2
						GET_ARRAY_ELEM ITEMS (((ITEM_INDEX-1)*20)+2) STOCKTYPE
					END_IF
				END_WHILE
			END_WHILE

			DECLARE_VARIABLE INTEGER TOTAL_STOCK_SHEETS
			DECLARE_VARIABLE INTEGER STOCK_SHEET_INDEX

			IF SHEET_INDEX > TOTAL_SHEETS
				TOTAL_STOCK_SHEETS = SHEET_INDEX - TOTAL_SHEETS
				STOCK_SHEET_INDEX = 1
				SHEET_INDEX = TOTAL_SHEETS + 1
				WHILE STOCK_SHEET_INDEX <= TOTAL_STOCK_SHEETS
					SET_DRW_CUR_SHEET refDrawing SHEET_INDEX
					CREATE_DRW_NOTE refDrawing 10.125 7.9375 itos(TOTAL_STOCK_SHEETS)
					SHEET_INDEX++
					STOCK_SHEET_INDEX++
				END_WHILE
			END_IF
		END_IF
	END_IF

	EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
	EXCEL_SAVE_DOCUMENT BOM_DOCUMENT_NAME

	EXCEL_DISCONNECT
	SAVE_MDL refDrawing
	WINDOW_CLOSE
	ERASE_NOT_DISPLAYED	
END_IF

IF DRAWINGS == 1
	DECLARE_ARRAY FILES
	DECLARE_ARRAY ITEMS	
	DECLARE_ARRAY TEST_ITEMS

	CLEAR_ARRAY FILES
	CLEAR_ARRAY ITEMS
	CLEAR_ARRAY TEST_ITEMS	
	
	GET_WORKING_DIRECTORY dir
	READ_DIRECTORY dir "*.drw" FILES
	GET_ARRAY_SIZE FILES sizeFILES

	EXCEL_CONNECT
	EXCEL_LOAD_DOCUMENT EXCEL_DOCUMENT_NAME
	EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "OPENING"
	EXCEL_GET_VALUE CELL_BY_NAME "B3" SO_NUM	

	IF SO_NUM == ""
		EOF = TRUE
	ELSE
		EOF = FALSE
	END_IF
	
	EXCEL_COLUMN = 1

	DECLARE_VARIABLE STRING ITEM
	DECLARE_VARIABLE STRING TEST_ITEM
	EXCEL_GET_VALUE 5 EXCEL_COLUMN ITEM_NUM
	
	WHILE EOF == FALSE
		TEST_ITEM = "asm_"+SO_NUM+"_"+ITEM_NUM+".drw"
		ADD_ARRAY_ELEM TEST_ITEMS TEST_ITEM		
		EXCEL_COLUMN++	
		EXCEL_GET_VALUE 5 EXCEL_COLUMN ITEM_NUM
		IF ITEM_NUM == ""
			EOF = TRUE
		ELSE
			EOF = FALSE
		END_IF
	END_WHILE
	
	GET_ARRAY_SIZE TEST_ITEMS sizeITEMS
	
	FOR FILE REF ARRAY FILES
		FIND_ARRAY_ELEM TEST_ITEMS FILE INDEX
		IF INDEX > -1
			DELETE_ARRAY_ELEM FILES INDEX
			ADD_ARRAY_ELEM ITEMS FILE
		END_IF
	END_FOR

	IF sizeFILES > 0
		FOR FILE REF ARRAY FILES
			RETRIEVE_MDL &FILE DRW
			GET_MDL_NAME DRW name
			REGEN_MDL DRW FORCE
			DECLARE_STRUCT PDF_OPTION option
			option.title = "sample drawing"
			option.author = "DRAFTER"
			option.subject = "detail"
			option.keywords = "SmartAssembly example"
			option.launch_viewer = "FALSE"
			option.color_depth = "Gray"
			EXPORT_DRW_PDF DRW option &name
			WINDOW_CLOSE
			ERASE_NOT_DISPLAYED
		END_FOR
	END_IF
	
	EXCEL_GET_VALUE CELL_BY_NAME "B3" SO_NUM

	IF SO_NUM == ""
		EOF = TRUE
	ELSE
		EOF = FALSE
	END_IF
	
	DECLARE_VARIABLE STRING ITEM_TO_PDF
	EXCEL_COLUMN = 1	
	
	WHILE EOF == FALSE
		EXCEL_GET_VALUE 5 EXCEL_COLUMN ITEM_NUM
		EXCEL_GET_VALUE 293 EXCEL_COLUMN MASTER_TAG
		EXCEL_GET_VALUE 295 EXCEL_COLUMN SHEET
		IF ITEM_NUM == MASTER_TAG
			ITEM_TO_PDF = "asm_"+SO_NUM+"_"+ITEM_NUM+".drw"
			RETRIEVE_MDL &ITEM_TO_PDF refDrawing
			DECLARE_STRUCT PDF_OPTION option
			option.title = "sample drawing"
			option.author = "DRAFTER"
			option.subject = "detail"
			option.keywords = "SmartAssembly example"
			option.launch_viewer = "FALSE"
			option.color_depth = "Gray"

			IF SHEET > 0 AND SHEET < 10
				EXPORT_DRW_PDF refDrawing option "00"+itos(SHEET)+"_"+SO_NUM+"_"+ ITEM_NUM
			ELSE_IF SHEET > 9 AND SHEET < 100
				EXPORT_DRW_PDF refDrawing option "0"+itos(SHEET)+"_"+SO_NUM+"_"+ ITEM_NUM
			ELSE_IF SHEET > 99
				EXPORT_DRW_PDF refDrawing option itos(SHEET)+"_"+SO_NUM+"_"+ ITEM_NUM
			END_IF		
		END_IF
		EXCEL_COLUMN++	
		EXCEL_GET_VALUE 5 EXCEL_COLUMN ITEM_NUM
		IF ITEM_NUM == ""
			EOF = TRUE
		ELSE
			EOF = FALSE
		END_IF
	END_WHILE
END_IF

EXCEL_DISCONNECT
WINDOW_CLOSE
ERASE_NOT_DISPLAYED	
MESSAGE_BOX "FINISHED"
END_ASM_DESCR
