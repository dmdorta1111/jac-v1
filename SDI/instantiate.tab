
BEGIN_ASM_DESCR

	DECLARE_REFERENCE COMP
	DECLARE_REFERENCE SUB_COMP
	DECLARE_REFERENCE INST
	
	DECLARE_ARRAY NAMES
	DECLARE_ARRAY INST_NAMES
	DECLARE_ARRAY SUB_COMP_INST_NAMES
	DECLARE_ARRAY ITEMS
	DECLARE_ARRAY SITEMS
	DECLARE_ARRAY SUB_COMP_ITEMS
	DECLARE_ARRAY COMP_ITEMS
	DECLARE_ARRAY GENERIC_SUB_COMP_INST_NAMES
	DECLARE_ARRAY GENERIC_ITEMS	
	DECLARE_ARRAY GENERIC_INST_NAMES
	DECLARE_ARRAY INSTANCES_TO_DELETE
	DECLARE_ARRAY NEW_INSTANCES
	
	
	DECLARE_VARIABLE INTEGER		INDEX
	DECLARE_VARIABLE INTEGER		SUB_COMP_INDEX	
	DECLARE_VARIABLE INTEGER		TEMP_INDEX
	DECLARE_VARIABLE STRING		MDL_NAME
	DECLARE_VARIABLE STRING		SUB_COMP_NAME
	DECLARE_VARIABLE STRING		NEW_INST_NAME
	DECLARE_VARIABLE STRING		INST_NAME
	DECLARE_VARIABLE STRING		NEW_SUB_COMP_INST_NAME	
	DECLARE_VARIABLE STRING		EXIST_INST_NAME
	DECLARE_VARIABLE STRING		MATCH
	DECLARE_VARIABLE INTEGER		TEMP_LENGTH
	DECLARE_VARIABLE STRING		TEMP_STRING
	DECLARE_VARIABLE STRING		REFER_NAME
	DECLARE_VARIABLE STRING		REFER_TYPE
	DECLARE_VARIABLE STRING		SUB_COMP_INST_NAME
	DECLARE_VARIABLE STRING		GENERIC_NAME
	DECLARE_VARIABLE STRING		GENERIC_TYPE
	DECLARE_VARIABLE INTEGER		ITEMNUM_COMP
	
	CLEAR_ARRAY	INSTANCES_TO_DELETE
	CLEAR_ARRAY	NEW_INSTANCES
	
	
	GET_REF_TYPE COMP Reftype

	BEGIN_CATCH_ERROR
		SEARCH_MDL_PARAM COMP "ITEMNUM" ITEMNUM
		IF ERROR OR ITEMNUM == ""
			ITEMNUM_COMP = 0
			CLEAR_ARRAY INST_NAMES
			GET_MDL_NAME COMP MDL_NAME	
			GET_FAMINSTANCE_NAMES COMP INST_NAMES
			INDEX = 0
			FOR INST_NAME REF ARRAY INST_NAMES
				GET_FAMITEM_VALUE COMP INST_NAME INDEX TEMP_INDEX
				IF INDEX <= TEMP_INDEX 
					INDEX = TEMP_INDEX
				END_IF
			END_FOR
				INDEX = INDEX + 1
			NEW_INST_NAME = MDL_NAME + "_" + itos(INDEX)
			
			INSERT_FAMINSTANCE COMP &NEW_INST_NAME
			
			SET_FAMITEM_VALUE COMP &NEW_INST_NAME "INDEX" INDEX			
			SET_FAMITEM_VALUE COMP &NEW_INST_NAME "EMJACNUM" "X"
			! SET_FAMITEM_VALUE COMP &NEW_INST_NAME "EMJACNUM" ""
			GET_REF_FAMINSTANCE COMP &NEW_INST_NAME INST
		ELSE_IF ITEMNUM <> ""
			ITEMNUM_COMP = 1
			NEW_INST_NAME = ITEMNUM
			INSERT_FAMINSTANCE COMP &NEW_INST_NAME	
			GET_REF_FAMINSTANCE COMP &NEW_INST_NAME INST
		END_IF
	END_CATCH_ERROR
	CLEAR_CATCH_ERROR

	CLEAR_ARRAY ITEMS
	GET_FAMITEMS COMP ITEMS
	
	FOR ITEM REF ARRAY ITEMS
		IF ITEM == "F*"
			CLEAR_CATCH_ERROR
			BEGIN_CATCH_ERROR
				SEARCH_MDL_PARAM COMP ITEM SITEM_PARAM
			END_CATCH_ERROR
			IF ERROR
				CLEAR_CATCH_ERROR
			ELSE		
				SEARCH_MDL_PARAM COMP ITEM VALUE
				SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM VALUE
			END_IF
		END_IF

		IF ITEM == "M*"
			CLEAR_CATCH_ERROR
			BEGIN_CATCH_ERROR
				SEARCH_MDL_PARAM COMP ITEM SITEM_PARAM
			END_CATCH_ERROR
			IF ERROR
				CLEAR_CATCH_ERROR
			ELSE		
				SEARCH_MDL_PARAM COMP ITEM VALUE
				SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM VALUE
			END_IF
		END_IF

		IF ITEM <> "INDEX" AND ITEM <> "EMJACNUM" AND ITEM <> "M*"
			IF ITEM == "F*"
				TEMP_LENGTH = strlen (ITEM)
				TEMP_STRING = strright(ITEM , TEMP_LENGTH-1)
				
				SEARCH_MDL_REFS ALLOW_SUPPRESSED COMP FEATURE "*" REFERS
				FOR  REFER REF ARRAY REFERS
					GET_REF_ID REFER REFER_ID
					GET_REF_STATE REFER REFER_STATE

					IF itos(REFER_ID) == TEMP_STRING
						GET_REF_NAME REFER REFER_NAME
						GET_REF_TYPE REFER REFER_TYPE
						GET_REF_STATE REFER REFER_STATE
						IF REFER_STATE == REF_ACTIVE
							SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM "Y"
						ELSE_IF REFER_STATE == REF_SUPPRESSED OR REFER_STATE == REF_MISSING
							SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM "N"
						END_IF
					END_IF
				END_FOR				
			ELSE
				SEARCH_MDL_PARAM COMP ITEM VALUE
				SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM VALUE
			END_IF			
		END_IF
	END_FOR
		
!COMPARE NEW INSTANCE WITH ALL OTHER INSTANCES
	CLEAR_ARRAY INST_NAMES
	GET_FAMINSTANCE_NAMES COMP INST_NAMES
	
	FOR EXIST_INST_NAME REF ARRAY INST_NAMES
PRINT "%" EXIST_INST_NAME
	END_FOR
	
	FOR EXIST_INST_NAME REF ARRAY INST_NAMES	
PRINT "%" EXIST_INST_NAME
		MATCH = "NO"
		IF EXIST_INST_NAME <> NEW_INST_NAME
			FOR ITEM REF ARRAY ITEMS
				IF ITEM <> "INDEX" AND ITEM <> "M*"	\
					AND ITEM <> "STOCKTYPE"		\
					AND ITEM <> "EMJACNUM"		\
					AND ITEM <> "EMJACDESC"		\
					AND ITEM <> "USED" 			\
					AND ITEM <> "STOCKED"		\
					AND ITEM <> "CSYS_CHECK"	\
					AND ITEM <> "INDEX"			\
					AND ITEM <> "Common Name"	\
					AND ITEM <> "XX*"				\
					AND ITEM <> "ITEMNUM"		\
					AND ITEM <> "PDF"
					
					
					GET_FAMITEM_VALUE COMP NEW_INST_NAME ITEM NEW_INST_ITEM_VALUE
					GET_FAMITEM_VALUE COMP EXIST_INST_NAME ITEM EXIST_INST_ITEM_VALUE					
				
					PRINT "ITEM   %    NEW   %   EXIST  %" ITEM NEW_INST_ITEM_VALUE EXIST_INST_ITEM_VALUE

					IF NEW_INST_ITEM_VALUE == EXIST_INST_ITEM_VALUE
						MATCH = "YES"
					ELSE
						MATCH = "NO"
						BREAK
					END_IF
				END_IF
			END_FOR
PRINT "*****************************                    %                         *************"	MATCH
			IF MATCH == "YES" AND (ITEMNUM_COMP == 0 OR ITEM_NUM == "")
				GET_REF_FAMINSTANCE COMP &EXIST_INST_NAME EXISTING_INST
PRINT "********************	   REPLACING   ***************************"
PRINT "COMP   %" COMP
PRINT "EXISTING_INST      %" EXISTING_INST
		
				REPLACE_COMPONENT COMP EXISTING_INST
				REGEN_MDL COMP FORCE
				DELETE_FAMINSTANCE COMP &NEW_INST_NAME
				BREAK
			END_IF
		END_IF
	END_FOR
	IF MATCH == "NO"
		IF Reftype == "PART"
			IF ITEMNUM_COMP == 0 OR ITEM_NUM == ""
				REPLACE_COMPONENT COMP INST
			END_IF
			INVALIDATE_REF COMP
			DECLARE_REFERENCE COMP INST
			REGEN_MDL COMP FORCE
			REGEN_MDL COMP FORCE			
		ELSE_IF Reftype == "ASSEMBLY"
			FOR ITEM REF ARRAY ITEMS
				IF ITEM == "M*"
					TEMP_LENGTH = strlen (ITEM)
					TEMP_STRING = strright(ITEM , TEMP_LENGTH-1)
					SEARCH_MDL_REFS COMP COMPONENT "*" REFERS
					REFER_NAME = ""
					REFER_TYPE = ""
					FOR  REFER REF ARRAY REFERS					
						GET_REF_ID REFER REFER_ID
						
						IF itos(REFER_ID) == TEMP_STRING
				
							GET_REF_NAME REFER REFER_NAME
							GET_REF_TYPE REFER REFER_TYPE
							IF REF_GENERIC REFER
								IF REFER_TYPE == "PART"
									REFER_TYPE = "GENERIC_PART"
								END_IF
							ELSE
								IF REFER_TYPE == "PART"
									REFER_TYPE = "INSTANCE_PART"
								END_IF					
							END_IF								
							BREAK
						END_IF
					END_FOR

					IF REFER_TYPE == "INSTANCE_PART"
						RETRIEVE_MDL REFER_NAME + ".PRT" REFER
						GET_REF_GENERIC REFER GENERIC
						GET_REF_NAME GENERIC GENERIC_NAME
						INVALIDATE_REF SUB_COMP
						RETRIEVE_MDL GENERIC_NAME + ".PRT" SUB_COMP
						SEARCH_MDL_PARAM SUB_COMP "STOCKTYPE" STOCK_TYPE
					ELSE_IF REFER_TYPE == "GENERIC_PART"				
	PRINT "REFER_NAME   % " REFER_NAME
						INVALIDATE_REF SUB_COMP
						RETRIEVE_MDL REFER_NAME + ".PRT" SUB_COMP
						SEARCH_MDL_PARAM SUB_COMP "STOCKTYPE" STOCK_TYPE
					END_IF
					
	PRINT "STOCKTYPE   % " STOCK_TYPE					
				
					IF STOCK_TYPE <> 3
					!CREATE NEW SUB COMPONENT INSTANCE					
						CLEAR_ARRAY SUB_COMP_INST_NAMES
						
						CLEAR_CATCH_ERROR
						BEGIN_CATCH_ERROR
							GET_MDL_NAME SUB_COMP SUB_COMP_NAME
						IF ERROR
							IF ITEM == "M*"
								TEMP_LENGTH = strlen (ITEM)
								TEMP_STRING = strright(ITEM , TEMP_LENGTH-1)
								
								SEARCH_MDL_REFS ALLOW_SUPPRESSED COMP COMPONENT "*" REFERS
								FOR  REFER REF ARRAY REFERS
									GET_REF_ID REFER REFER_ID
									GET_REF_STATE REFER REFER_STATE

									IF itos(REFER_ID) == TEMP_STRING
										GET_REF_NAME REFER REFER_NAME
										GET_REF_TYPE REFER REFER_TYPE
										GET_REF_STATE REFER REFER_STATE
										IF REFER_STATE == REF_SUPPRESSED OR REFER_STATE == REF_MISSING
											SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM "N"
										END_IF
									END_IF
								END_FOR				
							END_IF		
						
							END_CATCH_ERROR
							CLEAR_CATCH_ERROR
						ELSE
							GET_FAMINSTANCE_NAMES SUB_COMP SUB_COMP_INST_NAMES
							INDEX = 0
							FOR SUB_COMP_INST_NAME REF ARRAY SUB_COMP_INST_NAMES
								GET_FAMITEM_VALUE SUB_COMP SUB_COMP_INST_NAME INDEX TEMP_INDEX
		! PRINT "%" TEMP_INDEX
								IF INDEX <= TEMP_INDEX 
									INDEX = TEMP_INDEX
								END_IF
							END_FOR
		PRINT "INDEX % " INDEX					
								INDEX = INDEX + 1
							NEW_SUB_COMP_INST_NAME = SUB_COMP_NAME + "_" + itos(INDEX)
							
							INSERT_FAMINSTANCE SUB_COMP &NEW_SUB_COMP_INST_NAME
							SET_FAMITEM_VALUE SUB_COMP &NEW_SUB_COMP_INST_NAME "INDEX" INDEX
							SET_FAMITEM_VALUE SUB_COMP &NEW_SUB_COMP_INST_NAME "EMJACNUM" "X"
							
		PRINT "%" NEW_SUB_COMP_INST_NAME
		PRINT "INDEX % " INDEX


							GET_REF_FAMINSTANCE SUB_COMP &NEW_SUB_COMP_INST_NAME SUB_COMP_INST
							
							
							CLEAR_ARRAY SITEMS
							CLEAR_ARRAY SUB_COMP_ITEMS
							GET_FAMITEMS COMP SITEMS
							GET_FAMITEMS SUB_COMP SUB_COMP_ITEMS
							
							FOR SITEM REF ARRAY SITEMS
							
								IF SITEM == "F*"
									CLEAR_CATCH_ERROR
									BEGIN_CATCH_ERROR
										SEARCH_MDL_PARAM COMP SITEM SITEM_PARAM
									IF ERROR
										END_CATCH_ERROR
										CLEAR_CATCH_ERROR
									ELSE
										FIND_ARRAY_ELEM SUB_COMP_ITEMS SITEM arrayindex
										IF arrayindex <> -1
											SEARCH_MDL_PARAM COMP SITEM VALUE
											SET_FAMITEM_VALUE SUB_COMP &NEW_SUB_COMP_INST_NAME &SITEM VALUE
										END_IF
										END_CATCH_ERROR
										CLEAR_CATCH_ERROR
									END_IF
								END_IF

								IF SITEM == "M*"
									CLEAR_CATCH_ERROR
									BEGIN_CATCH_ERROR
										SEARCH_MDL_PARAM COMP SITEM SITEM_PARAM
									IF ERROR
										END_CATCH_ERROR
										CLEAR_CATCH_ERROR
									ELSE
										FIND_ARRAY_ELEM SUB_COMP_ITEMS SITEM arrayindex
										IF arrayindex <> -1
											SEARCH_MDL_PARAM COMP SITEM VALUE
											SET_FAMITEM_VALUE SUB_COMP &NEW_SUB_COMP_INST_NAME &SITEM VALUE
										END_IF
										END_CATCH_ERROR
										CLEAR_CATCH_ERROR
									END_IF
								END_IF
								
								IF SITEM <> "INDEX" AND SITEM <> "EMJACNUM" AND SITEM <> "M*" AND SITEM <> "F*" AND SITEM <> "STOCKTYPE"
									FIND_ARRAY_ELEM SUB_COMP_ITEMS SITEM arrayindex
									IF arrayindex <> -1
										SEARCH_MDL_PARAM COMP SITEM VALUE						
										SET_FAMITEM_VALUE SUB_COMP &NEW_SUB_COMP_INST_NAME &SITEM VALUE
									END_IF
								END_IF
							END_FOR
							
							SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM &NEW_SUB_COMP_INST_NAME						
							ADD_ARRAY_ELEM NEW_INSTANCES ITEM
							ADD_ARRAY_ELEM NEW_INSTANCES SUB_COMP
							ADD_ARRAY_ELEM NEW_INSTANCES NEW_SUB_COMP_INST_NAME
							
							END_CATCH_ERROR
							CLEAR_CATCH_ERROR
						END_IF
					END_IF
				! TEST NEW SUB COMPONENT INSTANCE
					
					! REGEN_MDL INST FORCE
					! REGEN_MDL INST FORCE
					
					! FOR EXIST_INST_NAME REF ARRAY SUB_COMP_INST_NAMES
						! MATCH = "NO"
						! IF EXIST_INST_NAME <> NEW_SUB_COMP_INST_NAME
							! FOR SUB_COMP_ITEM REF ARRAY SUB_COMP_ITEMS
								! IF SUB_COMP_ITEM <> "INDEX" AND SUB_COMP_ITEM <> "M*"	\
									! AND SUB_COMP_ITEM <> "STOCKTYPE"		\
									! AND SUB_COMP_ITEM <> "EMJACNUM"		\
									! AND SUB_COMP_ITEM <> "EMJACDESC"		\
									! AND SUB_COMP_ITEM <> "USED" 			\
									! AND SUB_COMP_ITEM <> "STOCKED"		\
									! AND SUB_COMP_ITEM <> "CSYS_CHECK"	\
									! AND SUB_COMP_ITEM <> "INDEX"			\
									! AND SUB_COMP_ITEM <> "Common Name"	\
									! AND SUB_COMP_ITEM <> "PDF"
									
									! GET_FAMITEM_VALUE SUB_COMP NEW_SUB_COMP_INST_NAME SUB_COMP_ITEM NEW_SUB_COMP_INST_ITEM_VALUE
									! GET_FAMITEM_VALUE SUB_COMP EXIST_INST_NAME SUB_COMP_ITEM EXIST_INST_ITEM_VALUE

									! IF NEW_SUB_COMP_INST_ITEM_VALUE == EXIST_INST_ITEM_VALUE
										! MATCH = "YES"
									! ELSE
										! MATCH = "NO"
										! BREAK
									! END_IF
								! END_IF
							! END_FOR
							
							! IF MATCH == "YES"
								! SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM &EXIST_INST_NAME
								! ADD_ARRAY_ELEM INSTANCES_TO_DELETE SUB_COMP
								! ADD_ARRAY_ELEM INSTANCES_TO_DELETE NEW_SUB_COMP_INST_NAME
								! BREAK
							! END_IF
						! END_IF
					! END_FOR
				END_IF
								
			END_FOR
			
			IF ITEMNUM_COMP == 0 OR ITEM_NUM == ""
				REPLACE_COMPONENT COMP INST
			END_IF
			
			! INVALIDATE_REF COMP
			! DECLARE_REFERENCE COMP INST
		END_IF
		
		REGEN_MDL INST FORCE

		PRINT "%" Reftype

		IF Reftype == "ASSEMBLY"
			CALL_EX replace.tab
				VAR_IN	INST	COMP
			END_CALL_EX
		END_IF
			
		INVALIDATE_REF COMP
		DECLARE_REFERENCE COMP INST		
	END_IF

	
! DECLARE_VARIABLE INTEGER ITP
! DECLARE_VARIABLE INTEGER INDEX 0
! DECLARE_VARIABLE STRING INS
	
! GET_ARRAY_SIZE 	INSTANCES_TO_DELETE SIZE
! ITP = SIZE

! INDEX = 0

! WHILE INDEX < SIZE
	! GET_ARRAY_ELEM INSTANCES_TO_DELETE INDEX MDL
	! PRINT "MDL %" MDL
	! INDEX++
	! GET_ARRAY_ELEM INSTANCES_TO_DELETE INDEX INS
	! PRINT "INS %" INS
	! INDEX++
	! DELETE_FAMINSTANCE MDL &INS	
! END_WHILE	
	! REGEN_MDL COMP FORCE

	
! FOR NEW_INST REF ARRAY NEW_INSTANCES
		! PRINT "%" NEW_INST
! END_FOR	
END_ASM_DESCR