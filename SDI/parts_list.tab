
BEGIN_ASM_DESCR
ENABLE_DATA_CAPTURE_MODE FALSE

DECLARE_VARIABLE	INTEGER	EXCEL_ROW 0
DECLARE_VARIABLE	INTEGER	STOCKTYPE
DECLARE_VARIABLE	STRING	DONE
DECLARE_VARIABLE	STRING	EXCEL_COMPONENT_NAME ""
DECLARE_VARIABLE	STRING	EXISTING_EXCEL
DECLARE_VARIABLE	STRING	PROCESS_STATE
DECLARE_VARIABLE	STRING	PROJECT_DIRECTORY
DECLARE_VARIABLE	STRING	BOM_DOCUMENT_NAME
DECLARE_VARIABLE	STRING	WO_NUM ""
DECLARE_VARIABLE	INTEGER	QUANTITY 1
DECLARE_VARIABLE	STRING	COMPONENT_NAME
DECLARE_VARIABLE	STRING	MDLTYPE
DECLARE_VARIABLE	STRING	MDLTYPE1
DECLARE_VARIABLE	STRING	MDLTYPE2
DECLARE_VARIABLE	INTEGER ITEM_QTY 1


! STOCKTYPE 1 = MANUFACTURED 
! STOCKTYPE 3 = STOCK PARTS
! STOCKTYPE 2 = PHANTOM ASSEMBLIES

ITEM_QTY = SHEET_QTY

DECLARE_ARRAY ALL_COMPONENTS
DECLARE_ARRAY CSYS_ARRAY

DECLARE_ARRAY EXCEL_FILES
CLEAR_ARRAY EXCEL_FILES
	
SEARCH_MDL_REFS ASSEM COMPONENT "*" ALL_COMPONENTS
GET_ARRAY_SIZE ALL_COMPONENTS Size
EXCEL_ACTIVATE_DOCUMENT BOM_DOCUMENT_NAME
EXCEL_ACTIVATE_SHEET SHEET_BY_NAME "LISTING"
EXCEL_ROW = 6

FOR EACH_COMPONENT REF ARRAY ALL_COMPONENTS
	GET_REF_NAME EACH_COMPONENT COMPONENT_NAME
	SEARCH_MDL_PARAM EACH_COMPONENT "STOCKTYPE" STOCKTYPE
	GET_MDL_EXTENSION EACH_COMPONENT EXTENSION

	IF STOCKTYPE == 1 AND EXTENSION == "prt"
		PROCESS_STATE = ""
		EXCEL_ROW = 6
		EXCEL_COMPONENT_NAME = ""

		WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
			EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
			IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
				EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
				EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + ITEM_QTY
			ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
				EXCEL_ROW++
			ELSE_IF EXCEL_COMPONENT_NAME == ""
				EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
				EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
				EXCEL_SET_VALUE EXCEL_ROW 3 ITEM_QTY
				PROCESS_STATE = "DONE"
			END_IF
		END_WHILE
	ELSE_IF STOCKTYPE == 3
		PROCESS_STATE = ""
		EXCEL_ROW = 6
		EXCEL_COMPONENT_NAME = ""

		WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
			GET_MDL_TYPE EACH_COMPONENT MDLTYPE
			EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
			IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
				EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
				EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + ITEM_QTY
			ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
				EXCEL_ROW++
			ELSE_IF EXCEL_COMPONENT_NAME == ""
				EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
				EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
				EXCEL_SET_VALUE EXCEL_ROW 3 ITEM_QTY
				EXCEL_SET_VALUE EXCEL_ROW 16 MDLTYPE
				PROCESS_STATE = "DONE"
			END_IF
		END_WHILE
	ELSE_IF STOCKTYPE == 4
		PROCESS_STATE = ""
		EXCEL_ROW = 6
		EXCEL_COMPONENT_NAME = ""

		GET_REF_GENERIC EACH_COMPONENT COMP_GENERIC
		GET_REF_NAME COMP_GENERIC GENERIC_NAME
		SEARCH_MDL_PARAM COMP_GENERIC "STOCKTYPE" STOCKTYPE
		GET_MDL_TYPE COMP_GENERIC MDLTYPE

		WHILE GENERIC_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
			EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
			IF GENERIC_NAME == EXCEL_COMPONENT_NAME
				EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
				EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + ITEM_QTY
			ELSE_IF GENERIC_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
				EXCEL_ROW++
			ELSE_IF EXCEL_COMPONENT_NAME == ""
				EXCEL_SET_VALUE EXCEL_ROW 1 GENERIC_NAME
				EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
				EXCEL_SET_VALUE EXCEL_ROW 3 ITEM_QTY
				EXCEL_SET_VALUE EXCEL_ROW 16 MDLTYPE
				PROCESS_STATE = "DONE"
			END_IF
		END_WHILE
	ELSE_IF (STOCKTYPE == 1 OR STOCKTYPE == 2) AND EXTENSION == "asm"
		DECLARE_ARRAY SUB_COMPONENTS1
		CLEAR_ARRAY SUB_COMPONENTS1
		SEARCH_MDL_REFS EACH_COMPONENT COMPONENT "*" SUB_COMPONENTS1

		FOR SUB_COMPONENT1 REF ARRAY SUB_COMPONENTS1
			GET_REF_NAME SUB_COMPONENT1 COMPONENT_NAME
			SEARCH_MDL_PARAM SUB_COMPONENT1 "STOCKTYPE" STOCKTYPE
			GET_MDL_EXTENSION SUB_COMPONENT1 EXTENSION

			IF STOCKTYPE == 1 AND EXTENSION == "prt"
				PROCESS_STATE = ""
				EXCEL_ROW = 6
				EXCEL_COMPONENT_NAME = ""

				WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
					EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
					IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
						EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
						EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + ITEM_QTY
					ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
						EXCEL_ROW++
					ELSE_IF EXCEL_COMPONENT_NAME == ""
						EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
						EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
						EXCEL_SET_VALUE EXCEL_ROW 3 ITEM_QTY
						PROCESS_STATE = "DONE"
					END_IF
				END_WHILE
			ELSE_IF STOCKTYPE == 3
				PROCESS_STATE = ""
				EXCEL_ROW = 6
				EXCEL_COMPONENT_NAME = ""

				WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
					GET_MDL_TYPE SUB_COMPONENT1 MDLTYPE1
					EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
					IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
						EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
						EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + ITEM_QTY
					ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
						EXCEL_ROW++
					ELSE_IF EXCEL_COMPONENT_NAME == ""
						EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
						EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
						EXCEL_SET_VALUE EXCEL_ROW 3 ITEM_QTY
						EXCEL_SET_VALUE EXCEL_ROW 16 MDLTYPE1
						PROCESS_STATE = "DONE"
					END_IF
				END_WHILE
			ELSE_IF STOCKTYPE == 4
				PROCESS_STATE = ""
				EXCEL_ROW = 6
				EXCEL_COMPONENT_NAME = ""

				GET_REF_GENERIC SUB_COMPONENT1 COMP_GENERIC
				GET_REF_NAME COMP_GENERIC GENERIC_NAME
				SEARCH_MDL_PARAM COMP_GENERIC "STOCKTYPE" STOCKTYPE
				GET_MDL_TYPE COMP_GENERIC MDLTYPE

				WHILE GENERIC_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
					EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
					IF GENERIC_NAME == EXCEL_COMPONENT_NAME
						EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
						EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + ITEM_QTY
					ELSE_IF GENERIC_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
						EXCEL_ROW++
					ELSE_IF EXCEL_COMPONENT_NAME == ""
						EXCEL_SET_VALUE EXCEL_ROW 1 GENERIC_NAME
						EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
						EXCEL_SET_VALUE EXCEL_ROW 3 ITEM_QTY
						EXCEL_SET_VALUE EXCEL_ROW 16 MDLTYPE
						PROCESS_STATE = "DONE"
					END_IF
				END_WHILE
			ELSE_IF (STOCKTYPE == 1 OR STOCKTYPE == 2) AND EXTENSION == "asm"
				DECLARE_ARRAY SUB_COMPONENTS2
				CLEAR_ARRAY SUB_COMPONENTS2
				SEARCH_MDL_REFS SUB_COMPONENT1 COMPONENT "*" SUB_COMPONENTS2

				FOR SUB_COMPONENT2 REF ARRAY SUB_COMPONENTS2
					GET_REF_NAME SUB_COMPONENT2 COMPONENT_NAME
					SEARCH_MDL_PARAM SUB_COMPONENT2 "STOCKTYPE" STOCKTYPE
					GET_MDL_EXTENSION SUB_COMPONENT2 EXTENSION

					IF STOCKTYPE == 1 AND EXTENSION == "prt"
						PROCESS_STATE = ""
						EXCEL_ROW = 6
						EXCEL_COMPONENT_NAME = ""

						WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
							EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
							IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
								EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
								EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + ITEM_QTY
							ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
								EXCEL_ROW++
							ELSE_IF EXCEL_COMPONENT_NAME == ""
								EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
								EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
								EXCEL_SET_VALUE EXCEL_ROW 3 ITEM_QTY
								PROCESS_STATE = "DONE"
							END_IF
						END_WHILE
					ELSE_IF STOCKTYPE == 3
						PROCESS_STATE = ""
						EXCEL_ROW = 6
						EXCEL_COMPONENT_NAME = ""

						WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME AND PROCESS_STATE <> "DONE"
							GET_MDL_TYPE SUB_COMPONENT2 MDLTYPE2
							EXCEL_GET_STRING EXCEL_ROW 1 EXCEL_COMPONENT_NAME
							IF COMPONENT_NAME == EXCEL_COMPONENT_NAME
								EXCEL_GET_VALUE EXCEL_ROW 3 QUANTITY
								EXCEL_SET_VALUE EXCEL_ROW 3 QUANTITY + ITEM_QTY
							ELSE_IF COMPONENET_NAME <> EXCEL_COMPONENT_NAME AND EXCEL_COMPONENT_NAME <> ""
								EXCEL_ROW++
							ELSE_IF EXCEL_COMPONENT_NAME == ""
								EXCEL_SET_VALUE EXCEL_ROW 1 COMPONENT_NAME
								EXCEL_SET_VALUE EXCEL_ROW 2 STOCKTYPE
								EXCEL_SET_VALUE EXCEL_ROW 3 ITEM_QTY
								EXCEL_SET_VALUE EXCEL_ROW 16 MDLTYPE2
								PROCESS_STATE = "DONE"
							END_IF
						END_WHILE
					END_IF
				END_FOR
			END_IF
		END_FOR
	END_IF
END_FOR
CLEAR_ARRAY ALL_COMPONENTS

EXCEL_SAVE_DOCUMENT BOM_DOCUMENT_NAME
! ERASE_NOT_DISPLAYED

END_ASM_DESCR
