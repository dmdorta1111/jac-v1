BEGIN_ASM_DESCR
	DECLARE_VARIABLE INTEGER ROW
	DECLARE_VARIABLE INTEGER TEST_ROW	
	DECLARE_VARIABLE INTEGER QUANTITY 1
	DECLARE_VARIABLE STRING EXCEL_COMPONENT_NAME ""
	DECLARE_VARIABLE INTEGER STOCKTYPE
	DECLARE_VARIABLE INTEGER MATCH
	DECLARE_VARIABLE STRING INSTANCE_NAME
	DECLARE_VARIABLE STRING COMPONENT_NAME
	DECLARE_VARIABLE STRING STATE
	DECLARE_VARIABLE DOUBLE LENGTH
	DECLARE_VARIABLE DOUBLE WIDTH
	DECLARE_VARIABLE DOUBLE X
	DECLARE_VARIABLE DOUBLE Y
	DECLARE_VARIABLE DOUBLE Z
	DECLARE_VARIABLE STRING EXCEL_DOCUMENT
	DECLARE_VARIABLE STRING TEST_EOF
	DECLARE_VARIABLE STRING TEST_COMPONENT
	DECLARE_VARIABLE DOUBLE TEST_THICKNESS
	DECLARE_VARIABLE STRING TEST_TYPE
	DECLARE_VARIABLE INTEGER TEST_GRADE
	DECLARE_VARIABLE INTEGER TEST_FINISH
	DECLARE_VARIABLE DOUBLE TEST_LENGTH
	DECLARE_VARIABLE DOUBLE TEST_WIDTH
	DECLARE_VARIABLE DOUBLE THICKNESS
	DECLARE_VARIABLE STRING TYPE
	DECLARE_VARIABLE INTEGER GRADE
	DECLARE_VARIABLE INTEGER FINISH
	

	DECLARE_REFERENCE ASSEM THIS	
	
	SEARCH_MDL_REFS RECURSIVE ASSEM COMPONENT * ALL_COMPONENTS
	
	ROW = 5
	
	EXCEL_DOCUMENT = "BOM_27655.xls"


	EXCEL_CONNECT
	EXCEL_LOAD_DOCUMENT EXCEL_DOCUMENT
	
	FOR EACH_COMPONENT REF ARRAY ALL_COMPONENTS
		GET_REF_NAME EACH_COMPONENT COMPONENT_NAME
			WHILE COMPONENT_NAME <> EXCEL_COMPONENT_NAME
				EXCEL_GET_STRING ROW 0 EXCEL_COMPONENT_NAME
				IF EXCEL_COMPONENT_NAME == ""
					SEARCH_MDL_PARAM EACH_COMPONENT "STOCKTYPE" STOCKTYPE
					GET_MDL_EXTENSION EACH_COMPONENT EXTENSION
					IF STOCKTYPE <> 0 AND EXTENSION == "prt"
						SEARCH_MDL_PARAM EACH_COMPONENT "SHAPE" SHAPE	
						MATCH = 0
						IF SHAPE == "SHEET"
							SWITCH_TO_MDL EACH_COMPONENT
							SEARCH_MDL_REF EACH_COMPONENT CSYS "*" REFCSYS
							SEARCH_MDL_PARAM EACH_COMPONENT "THICKNESS" THICKNESS
							SEARCH_MDL_PARAM EACH_COMPONENT "TYPE" TYPE
							SEARCH_MDL_PARAM EACH_COMPONENT "GRADE" GRADE
							SEARCH_MDL_PARAM EACH_COMPONENT "FINISH" FINISH							
							CALC_OUTLINE REFCSYS EACH_COMPONENT outline

							IF outline.x1 < outline.x2
								X = outline.x2 - outline.x1
							ELSE 
								X = outline.x1 - outline.x2
							END_IF
								IF X < 0
									X = X*-1
								END_IF
							IF outline.y1 < outline.y2
								Y = outline.y2 - outline.y1
							ELSE 
								Y = outline.y1 - outline.y2
							END_IF
								IF Y < 0
									Y = Y*-1
								END_IF
							IF outline.z1 < outline.z2
								Z = outline.z2 - outline.z1
							ELSE 
								Z = outline.z1 - outline.z2
							END_IF
								IF Z < 0
									Z = Z*-1
								END_IF
								
							IF X > THICKNESS*1.5 AND Y > THICKNESS*1.5 AND Z > THICKNESS*1.5
								STATE = "FORMED"
							ELSE
								STATE = "FLAT"
							END_IF
							
							IF STATE == "FLAT"
							
								SEARCH_MDL_REF EACH_COMPONENT CSYS "*" REFCSYS												
								CALC_OUTLINE_PARAM REFCSYS X_SIZE X
								CALC_OUTLINE_PARAM REFCSYS Y_SIZE Y
								CALC_OUTLINE_PARAM REFCSYS Z_SIZE Z							
							
								IF X > Y AND X > Z
									LENGTH = X
									IF Y > Z
										WIDTH = Y
									ELSE
										WIDTH = Z
									END_IF
								END_IF
								IF Y > Z AND Y > X
									LENGTH = Y
									IF Z > X
										WIDTH = Z
									ELSE
										WIDTH = X
									END_IF
								END_IF
								IF Z > X AND Z > Y
									LENGTH = Z
									IF X > Y
										WIDTH = X
									ELSE
										WIDTH = Y
									END_IF
								END_IF
							ELSE_IF STATE == "FORMED"
								GET_REF_NAME EACH_COMPONENT COMPONENT_NAME
								GET_REF_GENERIC EACH_COMPONENT COMPONENT_GENERIC
								GET_REF_NAME COMPONENT_GENERIC GENERIC_NAME
								
								IF COMPONENT_NAME == GENERIC_NAME
									SEARCH_MDL_REF EACH_COMPONENT SURFACE "*" FIRST_SURF
									CREATE_UDF lib:udf\unbend EACH_COMPONENT
										UDF_REF surface FIRST_SURF
										UDF_EXP_REF FLAT FEATURE 0
									END_CREATE_UDF
								ELSE_IF COMPONENT_NAME <> GENERIC_NAME
									SWITCH_TO_MDL COMPONENT_GENERIC
									SEARCH_MDL_REF COMPONENT_GENERIC SURFACE "*" FIRST_SURF
									CREATE_UDF lib:udf\unbend COMPONENT_GENERIC
										UDF_REF surface FIRST_SURF
										UDF_EXP_REF FLAT FEATURE 0
									END_CREATE_UDF
									SWITCH_TO_MDL EACH_COMPONENT
									REGEN_MDL EACH_COMPONENT
								END_IF
								
								SEARCH_MDL_REF EACH_COMPONENT CSYS "*" REFCSYS												
								CALC_OUTLINE_PARAM REFCSYS X_SIZE X
								CALC_OUTLINE_PARAM REFCSYS Y_SIZE Y
								CALC_OUTLINE_PARAM REFCSYS Z_SIZE Z
								
								IF X > Y AND X > Z
									LENGTH = X
									IF Y > Z
										WIDTH = Y
									ELSE
										WIDTH = Z
									END_IF
								END_IF
								IF Y > Z AND Y > X
									LENGTH = Y
									IF Z > X
										WIDTH = Z
									ELSE
										WIDTH = X
									END_IF
								END_IF
								IF Z > X AND Z > Y
									LENGTH = Z
									IF X > Y
										WIDTH = X
									ELSE
										WIDTH = Y
									END_IF
								END_IF
								
								IF COMPONENT_NAME == GENERIC_NAME
									REMOVE_FEATURE FLAT
									SWITCH_TO_MDL ASSEM
								ELSE_IF COMPONENT_NAME <> GENERIC_NAME
									SWITCH_TO_MDL COMPONENT_GENERIC
									REMOVE_FEATURE FLAT
									SWITCH_TO_MDL ASSEM
								END_IF
							END_IF
								TEST_ROW = 5
								TEST_EOF = FALSE
								WHILE TEST_EOF == FALSE
									EXCEL_GET_VALUE TEST_ROW 0 TEST_COMPONENT
									EXCEL_GET_VALUE TEST_ROW 3 TEST_THICKNESS
									
									IF TEST_COMPONENT <> "" OR TEST_THICKNESS > 0
										EXCEL_GET_VALUE TEST_ROW 4 TEST_TYPE
										! EXCEL_GET_VALUE TEST_ROW 5 TEST_GRADE
										! EXCEL_GET_VALUE TEST_ROW 6 TEST_FINISH
										EXCEL_GET_VALUE TEST_ROW 7 TEST_LENGTH
										EXCEL_GET_VALUE TEST_ROW 8 TEST_WIDTH							
											
										! IF THICKNESS == TEST_THICKNESS AND TYPE == TEST_TYPE AND GRADE == TEST_GRADE AND \
											! FINISH == TEST_FINISH AND LENGTH == TEST_LENGTH AND WIDTH == TEST_WIDTH	
										IF THICKNESS == TEST_THICKNESS AND TYPE == TEST_TYPE AND LENGTH == TEST_LENGTH AND WIDTH == TEST_WIDTH												
											
											EXCEL_GET_VALUE TEST_ROW 2 QUANTITY
											QUANTITY = QUANTITY + 1
											EXCEL_SET_VALUE TEST_ROW 2 QUANTITY
											MATCH = 1

											BREAK
										END_IF
									END_IF
								
									TEST_ROW ++
									EXCEL_GET_VALUE TEST_ROW 0 TEST_COMPONENT
									EXCEL_GET_VALUE TEST_ROW 3 TEST_THICKNESS
									IF TEST_COMPONENT <> "" OR TEST_THICKNESS > 0
										TEST_EOF = FALSE
									ELSE
										TEST_EOF = TRUE
									END_IF
								END_WHILE
								
							IF MATCH == 0
								EXCEL_SET_VALUE ROW 0 COMPONENT_NAME
								EXCEL_SET_VALUE ROW 2 QUANTITY
								EXCEL_SET_VALUE ROW 3 THICKNESS
								EXCEL_SET_VALUE ROW 4 TYPE
								EXCEL_SET_VALUE ROW 5 GRADE
								EXCEL_SET_VALUE ROW 6 FINISH 
								EXCEL_SET_VALUE ROW 7 LENGTH
								EXCEL_SET_VALUE ROW 8 WIDTH
							END_IF
						END_IF
					END_IF
					BREAK
				ELSE_IF EXCEL_COMPONENT_NAME == COMPONENT_NAME
					EXCEL_GET_VALUE ROW 2 QUANTITY
					QUANTITY = QUANTITY+1
					EXCEL_SET_VALUE ROW 2 QUANTITY
				ELSE_IF EXCEL_COMPONENT_NAME <> COMPONENT_NAME
					ROW = ROW+1
				END_IF
			END_WHILE
			
		ROW = 5
		QUANTITY = 1
		EXCEL_COMPONENT_NAME = ""
	END_FOR
	
	SWITCH_TO_MDL ASSEM
	GET_MDL_NAME ASSEMBLY ASM_MDL_NAME
	EXCEL_SAVE_DOCUMENT EXCEL_DOCUMENT
	
	
EXCEL_DISCONNECT
WINDOW_CLOSE
WINDOW_CLOSE
ERASE_NOT_DISPLAYED

END_ASM_DESCR
