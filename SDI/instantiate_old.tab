
BEGIN_ASM_DESCR

	DECLARE_REFERENCE COMP
	! IF REF_VALID COMP
		! PRINT "%" COMP
		! STOP
	! ELSE
		! DECLARE_REFERENCE COMP THIS
	! END_IF
	
	DECLARE_REFERENCE SUB_COMP
	DECLARE_REFERENCE INST
	
	DECLARE_ARRAY NAMES
	DECLARE_ARRAY SUB_COMP_INST_NAMES
	DECLARE_ARRAY INST_NAMES
	DECLARE_ARRAY ITEMS
	DECLARE_ARRAY SUB_COMP_ITEMS
	DECLARE_ARRAY COMP_ITEMS
	DECLARE_ARRAY GENERIC_SUB_COMP_INST_NAMES
	DECLARE_ARRAY GENERIC_ITEMS	
	DECLARE_ARRAY GENERIC_INST_NAMES
	
	DECLARE_VARIABLE INTEGER		INDEX
	DECLARE_VARIABLE INTEGER		SUB_COMP_INDEX	
	DECLARE_VARIABLE INTEGER		TEMP_INDEX
	DECLARE_VARIABLE STRING		MDL_NAME
	DECLARE_VARIABLE STRING		SUB_COMP_NAME
	DECLARE_VARIABLE STRING		NEW_INST_NAME
	DECLARE_VARIABLE STRING		INST_NAME
	DECLARE_VARIABLE STRING		NEW_SUB_COMP_INST_NAME	
	DECLARE_VARIABLE STRING		EXIST_INST_NAME
	DECLARE_VARIABLE STRING		MATCH
	DECLARE_VARIABLE INTEGER		TEMP_LENGTH
	DECLARE_VARIABLE STRING		TEMP_STRING
	DECLARE_VARIABLE STRING		REFER_NAME
	DECLARE_VARIABLE STRING		REFER_TYPE
	DECLARE_VARIABLE STRING		SUB_COMP_INST_NAME
	
	GET_REF_TYPE COMP Reftype

	CLEAR_ARRAY NAMES
	GET_MDL_NAME COMP MDL_NAME	
	GET_FAMINSTANCE_NAMES COMP NAMES
	INDEX = 0
	FOR NAME REF ARRAY NAMES
		GET_FAMITEM_VALUE COMP NAME INDEX TEMP_INDEX
		IF TEMP_INDEX > INDEX
			INDEX = TEMP_INDEX
			BREAK
		END_IF
		INDEX++
	END_FOR
	NEW_INST_NAME = MDL_NAME + "_" + itos(INDEX)
	
	INSERT_FAMINSTANCE COMP &NEW_INST_NAME
	SET_FAMITEM_VALUE COMP &NEW_INST_NAME "INDEX" INDEX
	SET_FAMITEM_VALUE COMP &NEW_INST_NAME "EMJACNUM" ""
	
	GET_REF_FAMINSTANCE COMP &NEW_INST_NAME INST
	
!PARTS
	IF Reftype == "PART"
		CLEAR_ARRAY ITEMS
		GET_FAMITEMS COMP ITEMS
		FOR ITEM REF ARRAY ITEMS
			IF ITEM <> "INDEX"	AND ITEM <> "EMJACNUM"				
				SEARCH_MDL_PARAM COMP ITEM VALUE
				SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM VALUE
			END_IF
		END_FOR
			
	!COMPARE NEW INSTANCE WITH ALL OTHER INSTANCES
		CLEAR_ARRAY INST_NAMES
		GET_FAMINSTANCE_NAMES COMP INST_NAMES
		
		FOR EXIST_INST_NAME REF ARRAY INST_NAMES
			MATCH = "NO"
			IF EXIST_INST_NAME <> NEW_INST_NAME
				FOR ITEM REF ARRAY ITEMS
					IF ITEM <> "INDEX" 				\
						OR ITEM <> "STOCKTYPE"		\
						OR ITEM <> "EMJACNUM"		\
						OR ITEM <> "EMJACDESC"		\
						OR ITEM <> "USED" 			\
						OR ITEM <> "STOCKED"		\
						OR ITEM <> "CSYS_CHECK"		\
						OR ITEM <> "INDEX"			\
						OR ITEM <> "Common Name"		\
						OR ITEM <> "PDF"
						
						GET_FAMITEM_VALUE COMP NEW_INST_NAME ITEM NEW_INST_ITEM_VALUE
						GET_FAMITEM_VALUE COMP EXIST_INST_NAME ITEM EXIST_INST_ITEM_VALUE

						IF NEW_INST_ITEM_VALUE == EXIST_INST_ITEM_VALUE
							MATCH = "YES"
						ELSE
							MATCH = "NO"
							BREAK
						END_IF
					END_IF
				END_FOR
				IF MATCH == "YES"
					GET_REF_FAMINSTANCE COMP &EXIST_INST_NAME EXISTING_INST
					REPLACE_COMPONENT COMP EXISTING_INST
					DELETE_FAMINSTANCE COMP &NEW_INST_NAME
					BREAK
				END_IF
			END_IF
		END_FOR
		IF MATCH == "NO"
			REPLACE_COMPONENT COMP INST
			INVALIDATE_REF COMP
			DECLARE_REFERENCE COMP INST
		END_IF
	END_IF	
	
! ASSEMBLIES	
	IF Reftype == "ASSEMBLY"
		CLEAR_ARRAY ITEMS
		GET_FAMITEMS COMP ITEMS

		FOR ITEM REF ARRAY ITEMS
			IF ITEM <> "INDEX" 				\
				AND ITEM <> "STOCKTYPE"		\
				AND ITEM <> "EMJACNUM"		\
				AND ITEM <> "EMJACDESC"		\
				AND ITEM <> "USED" 			\
				AND ITEM <> "STOCKED"		\
				AND ITEM <> "CSYS_CHECK"	\
				AND ITEM <> "INDEX"			\
				AND ITEM <> "Common Name"	\
				AND ITEM <> "PDF"			\
				AND ITEM <> "M*"
				
				SEARCH_MDL_PARAM COMP ITEM VALUE
				SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM VALUE

			ELSE_IF ITEM == "M*"
				TEMP_LENGTH = strlen (ITEM)
				TEMP_STRING = strright(ITEM , TEMP_LENGTH-1)
				SEARCH_MDL_REFS COMP COMPONENT "*" REFERS
				REFER_NAME = ""
				REFER_TYPE = ""
				FOR  REFER REF ARRAY REFERS					
					GET_REF_ID REFER REFER_ID
					
					IF itos(REFER_ID) == TEMP_STRING
						GET_REF_NAME REFER REFER_NAME
						GET_REF_TYPE REFER REFER_TYPE
					END_IF

					IF REF_GENERIC REFER
						IF REFER_TYPE == "PART"
							REFER_TYPE = "GENERIC_PART"
						END_IF
					ELSE
						IF REFER_TYPE == "PART"
							REFER_TYPE = "INSTANCE_PART"
						END_IF					
					END_IF
					
					IF REFER_NAME <> "" AND REFER_TYPE <> ""
						BREAK
					END_IF
					
				END_FOR
						
				IF REFER_TYPE == "GENERIC_PART"
					RETRIEVE_MDL REFER_NAME + ".PRT" SUB_COMP

					CLEAR_ARRAY SUB_COMP_INST_NAMES
					GET_FAMINSTANCE_NAMES SUB_COMP SUB_COMP_INST_NAMES
					
					FOR SUB_COMP_INST_NAME REF ARRAY SUB_COMP_INST_NAMES
						PRINT "154 CHECKING  %" SUB_COMP_INST_NAME
						CLEAR_ARRAY SUB_COMP_ITEMS
						GET_FAMITEMS SUB_COMP SUB_COMP_ITEMS
						MATCH = "YES"
						FOR SUB_COMP_ITEM REF ARRAY SUB_COMP_ITEMS						
							IF SUB_COMP_ITEM <> "INDEX" 					\
								AND SUB_COMP_ITEM <> "STOCKTYPE"		\
								AND SUB_COMP_ITEM <> "EMJACNUM"			\
								AND SUB_COMP_ITEM <> "EMJACDESC"		\
								AND SUB_COMP_ITEM <> "USED" 				\
								AND SUB_COMP_ITEM <> "STOCKED"			\
								AND SUB_COMP_ITEM <> "CSYS_CHECK"		\
								AND SUB_COMP_ITEM <> "INDEX"				\
								AND SUB_COMP_ITEM <> "Common Name"		\
								AND SUB_COMP_ITEM <> "PDF"
							
								PRINT "182  MATCH % " 	MATCH
							
								CLEAR_ARRAY COMP_ITEMS
								GET_FAMITEMS COMP COMP_ITEMS
								FOR COMP_ITEM REF ARRAY COMP_ITEMS
									IF COMP_ITEM <> "INDEX" 				\
										AND COMP_ITEM <> "STOCKTYPE"	\
										AND COMP_ITEM <> "EMJACNUM"		\
										AND COMP_ITEM <> "EMJACDESC"	\
										AND COMP_ITEM <> "USED" 			\
										AND COMP_ITEM <> "STOCKED"		\
										AND COMP_ITEM <> "CSYS_CHECK"	\
										AND COMP_ITEM <> "INDEX"			\
										AND COMP_ITEM <> "Common Name"	\
										AND COMP_ITEM <> "PDF"

										GET_FAMITEM_VALUE SUB_COMP SUB_COMP_INST_NAME SUB_COMP_ITEM SUB_COMP_ITEM_VALUE
										IF COMP_ITEM == SUB_COMP_ITEM
											SEARCH_MDL_PARAM COMP COMP_ITEM VALUE
											PRINT "SUB_COMP_ITEM  SUB_COMP_ITEM_VALUE %  %" SUB_COMP_ITEM  SUB_COMP_ITEM_VALUE 
											PRINT "COMP_ITEM  VALUE %  %" COMP_ITEM  VALUE 
											IF VALUE == SUB_COMP_ITEM_VALUE
												MATCH = "YES"
											ELSE
												MATCH = "NO"
												BREAK
											END_IF
										END_IF
									END_IF
								END_FOR
							END_IF
						END_FOR
						IF MATCH == "YES"
							PRINT " 186  MATCH FOUND %" 								
							PRINT " 187  %" SUB_COMP_INST_NAME						
							BREAK
						END_IF
					END_FOR
					
					IF MATCH == "YES"
						SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM &SUB_COMP_INST_NAME
					ELSE_IF MATCH == "NO"
						CLEAR_ARRAY SUB_COMP_INST_NAMES
						GET_MDL_NAME SUB_COMP SUB_COMP_NAME	
						GET_FAMINSTANCE_NAMES SUB_COMP SUB_COMP_INST_NAMES
						GET_FAMITEMS SUB_COMP SUB_COMP_ITEMS
						SUB_COMP_INDEX = 0

						FOR SUB_COMP_INST_NAME REF ARRAY SUB_COMP_INST_NAMES
							GET_FAMITEM_VALUE SUB_COMP &SUB_COMP_INST_NAME "INDEX" TEMP_INDEX
							IF TEMP_INDEX > SUB_COMP_INDEX
								SUB_COMP_INDEX = TEMP_INDEX
								BREAK
							END_IF
							SUB_COMP_INDEX++
						END_FOR
						
						NEW_SUB_COMP_INST_NAME = SUB_COMP_NAME + "_" + itos(SUB_COMP_INDEX)
						INSERT_FAMINSTANCE SUB_COMP &NEW_SUB_COMP_INST_NAME
						SET_FAMITEM_VALUE SUB_COMP &NEW_SUB_COMP_INST_NAME "INDEX" SUB_COMP_INDEX					

						CLEAR_ARRAY SUB_COMP_ITEMS
						GET_FAMITEMS SUB_COMP SUB_COMP_ITEMS
						
						CLEAR_ARRAY COMP_ITEMS
						GET_FAMITEMS COMP COMP_ITEMS			

						FOR SUB_COMP_ITEM REF ARRAY SUB_COMP_ITEMS
							IF SUB_COMP_ITEM <> "INDEX" AND SUB_COMP_ITEM <> "EMJACNUM"
							
								FOR COMP_ITEM REF ARRAY COMP_ITEMS
									IF COMP_ITEM == SUB_COMP_ITEM
										SEARCH_MDL_PARAM COMP COMP_ITEM VALUE
										SET_FAMITEM_VALUE SUB_COMP &NEW_SUB_COMP_INST_NAME &SUB_COMP_ITEM VALUE
										BREAK
									END_IF
								END_FOR
							END_IF
						END_FOR
		
						SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM NEW_SUB_COMP_INST_NAME
					END_IF
				END_IF

				IF REFER_TYPE == "INSTANCE_PART"

					RETRIEVE_MDL REFER_NAME + ".PRT" SUB_COMP
				
!CREATE NEW INSTANCE
					GET_REF_GENERIC SUB_COMP GENERIC
					GET_REF_NAME GENERIC GENERIC_NAME
					
					RETRIEVE_MDL GENERIC_NAME + ".PRT" GENERIC

					CLEAR_ARRAY INST_NAMES
					GET_FAMINSTANCE_NAMES GENERIC INST_NAMES
					SUB_COMP_INDEX = 0

					FOR INST_NAME REF ARRAY INST_NAMES
						GET_FAMITEM_VALUE GENERIC &INST_NAME "INDEX" TEMP_INDEX
						IF TEMP_INDEX > SUB_COMP_INDEX
							SUB_COMP_INDEX = TEMP_INDEX
							BREAK
						END_IF
						SUB_COMP_INDEX++
					END_FOR
					
					NEW_SUB_COMP_INST_NAME = GENERIC_NAME + "_" + itos(SUB_COMP_INDEX)
					INSERT_FAMINSTANCE GENERIC &NEW_SUB_COMP_INST_NAME
					SET_FAMITEM_VALUE GENERIC &NEW_SUB_COMP_INST_NAME "INDEX" SUB_COMP_INDEX
					
					
					CLEAR_ARRAY GENERIC_ITEMS
					GET_FAMITEMS GENERIC GENERIC_ITEMS

					FOR GENERIC_ITEM REF ARRAY GENERIC_ITEMS
						IF GENERIC_ITEM <> "INDEX" AND GENERIC_ITEM <> "EMJACNUM" AND GENERIC_ITEM <> "COMMENTS"
							GET_FAMITEM_VALUE GENERIC &REFER_NAME &GENERIC_ITEM VALUE
							SET_FAMITEM_VALUE GENERIC &NEW_SUB_COMP_INST_NAME &GENERIC_ITEM VALUE
						END_IF
					END_FOR
					
					FOR GENERIC_ITEM REF ARRAY GENERIC_ITEMS
						IF GENERIC_ITEM <> "INDEX" AND GENERIC_ITEM <> "EMJACNUM" AND GENERIC_ITEM <> "COMMENTS"
							CLEAR_ARRAY COMP_ITEMS					
							GET_FAMITEMS COMP COMP_ITEMS
							
							BEGIN_CATCH_ERROR
								FOR COMP_ITEM REF ARRAY COMP_ITEMS
									IF COMP_ITEM == GENERIC_ITEM
										SEARCH_MDL_PARAM COMP COMP_ITEM VALUE
										SET_FAMITEM_VALUE GENERIC &NEW_SUB_COMP_INST_NAME GENERIC_ITEM VALUE
										BREAK
									END_IF
								END_FOR
							END_CATCH_ERROR		
						END_IF
					END_FOR	
					
					GET_REF_FAMINSTANCE GENERIC &NEW_SUB_COMP_INST_NAME NEW_INST_REF
					REGEN_MDL NEW_INST_REF
					REGEN_MDL NEW_INST_REF
					
!END CREATE NEW INSTANCE

!COMPARE INSTANCES					
					
					CLEAR_ARRAY INST_NAMES
					GET_FAMINSTANCE_NAMES GENERIC INST_NAMES
					
					FOR EXIST_INST_NAME REF ARRAY INST_NAMES
						MATCH = "NO"
						IF EXIST_INST_NAME <> NEW_SUB_COMP_INST_NAME						
							CLEAR_ARRAY GENERIC_ITEMS
							GET_FAMITEMS GENERIC GENERIC_ITEMS
						
							FOR GENERIC_ITEM REF ARRAY GENERIC_ITEMS
								IF GENERIC_ITEM == "INDEX" 				\
									OR GENERIC_ITEM == "STOCKTYPE"		\
									OR GENERIC_ITEM == "EMJACNUM"		\
									OR GENERIC_ITEM == "EMJACDESC"		\
									OR GENERIC_ITEM == "USED" 			\
									OR GENERIC_ITEM == "STOCKED"		\
									OR GENERIC_ITEM == "CSYS_CHECK"		\
									OR GENERIC_ITEM == "INDEX"			\
									OR GENERIC_ITEM == "Common Name"		\
									OR GENERIC_ITEM == "PDF"
									MATCH = "YES"
								ELSE
									GET_FAMITEM_VALUE GENERIC NEW_SUB_COMP_INST_NAME GENERIC_ITEM NEW_INST_ITEM_VALUE
									GET_FAMITEM_VALUE GENERIC EXIST_INST_NAME GENERIC_ITEM EXIST_INST_ITEM_VALUE

									IF NEW_INST_ITEM_VALUE == EXIST_INST_ITEM_VALUE
										MATCH = "YES"
									ELSE
										MATCH = "NO"
										BREAK
									END_IF
								END_IF
							END_FOR
							IF MATCH == "YES"
								SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM EXIST_INST_NAME
								DELETE_FAMINSTANCE GENERIC &NEW_SUB_COMP_INST_NAME
								BREAK
							END_IF
						END_IF
					END_FOR
					IF MATCH == "NO"
						SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM NEW_SUB_COMP_INST_NAME
					END_IF					
				END_IF

			ELSE_IF ITEM == "F*"

				TEMP_LENGTH = strlen (ITEM)
				TEMP_STRING = strright(ITEM , TEMP_LENGTH-1)
				
				SEARCH_MDL_REFS ALLOW_SUPPRESSED COMP FEATURE "*" REFERS
				FOR  REFER REF ARRAY REFERS
					GET_REF_ID REFER REFER_ID
					GET_REF_STATE REFER REFER_STATE

					IF itos(REFER_ID) == TEMP_STRING
						GET_REF_NAME REFER REFER_NAME
						GET_REF_TYPE REFER REFER_TYPE
						GET_REF_STATE REFER REFER_STATE
						IF REFER_STATE == REF_ACTIVE
							SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM "Y"
						ELSE_IF REFER_STATE == REF_SUPPRESSED OR REFER_STATE == REF_MISSING
							SET_FAMITEM_VALUE COMP &NEW_INST_NAME &ITEM "N"
						END_IF
					END_IF
				END_FOR
			END_IF
		END_FOR
					
! COMPARE NEW INSTANCE WITH ALL OTHER INSTANCES
		CLEAR_ARRAY INST_NAMES
		GET_FAMINSTANCE_NAMES COMP INST_NAMES
		
		FOR EXIST_INST_NAME REF ARRAY INST_NAMES
			MATCH = "NO"
			IF EXIST_INST_NAME <> NEW_INST_NAME
				FOR ITEM REF ARRAY ITEMS
					IF ITEM == "INDEX" 				\
						OR ITEM == "STOCKTYPE"		\
						OR ITEM == "EMJACNUM"		\
						OR ITEM == "EMJACDESC"		\
						OR ITEM == "USED" 			\
						OR ITEM == "STOCKED"		\
						OR ITEM == "CSYS_CHECK"		\
						OR ITEM == "INDEX"			\
						OR ITEM == "Common Name"		\
						OR ITEM == "PDF"
						MATCH = "YES"
					ELSE
						GET_FAMITEM_VALUE COMP NEW_INST_NAME ITEM NEW_INST_ITEM_VALUE
						GET_FAMITEM_VALUE COMP EXIST_INST_NAME ITEM EXIST_INST_ITEM_VALUE

						IF NEW_INST_ITEM_VALUE == EXIST_INST_ITEM_VALUE
							MATCH = "YES"
						ELSE
							MATCH = "NO"
							BREAK
						END_IF
					END_IF
				END_FOR
				IF MATCH == "YES"
					GET_REF_FAMINSTANCE COMP &EXIST_INST_NAME EXISTING_INST
					REPLACE_COMPONENT COMP EXISTING_INST
					DELETE_FAMINSTANCE COMP &NEW_INST_NAME
					BREAK
				END_IF
			END_IF
		END_FOR
		IF MATCH == "NO"
			REPLACE_COMPONENT COMP INST
			INVALIDATE_REF COMP
			DECLARE_REFERENCE COMP INST			
		END_IF
	END_IF
	
	REGEN_MDL COMP FORCE
	REGEN_MDL COMP FORCE
	
END_ASM_DESCR
